module.exports=function(e){function n(a){if(t[a])return t[a].exports;var d=t[a]={i:a,l:!1,exports:{}};return e[a].call(d.exports,d,d.exports,n),d.l=!0,d.exports}var t={};return n.m=e,n.c=t,n.d=function(e,t,a){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:a})},n.n=function(e){var t=e&&e.__esModule?function(){return e['default']}:function(){return e};return n.d(t,'a',t),t},n.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},n.p='',n(n.s=12)}([function(e){e.exports=require('source-map-support/register')},function(e){e.exports=require('babel-runtime/core-js/object/keys')},function(e){e.exports=require('babel-runtime/core-js/promise')},function(e){e.exports=require('babel-runtime/helpers/asyncToGenerator')},function(e){e.exports=require('clientnode')},function(e){e.exports=require('path')},function(module,exports,__webpack_require__){'use strict';function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}exports.__esModule=!0,exports.Helper=void 0;var _keys=__webpack_require__(1),_keys2=_interopRequireDefault(_keys),_promise=__webpack_require__(2),_promise2=_interopRequireDefault(_promise),_asyncToGenerator2=__webpack_require__(3),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_child_process=__webpack_require__(7),_clientnode=__webpack_require__(4),_clientnode2=_interopRequireDefault(_clientnode),_nodeFetch=__webpack_require__(8),_nodeFetch2=_interopRequireDefault(_nodeFetch),_path=__webpack_require__(5),_path2=_interopRequireDefault(_path),_pluginAPI=__webpack_require__(9),_pluginAPI2=_interopRequireDefault(_pluginAPI);try{__webpack_require__(0)}catch(e){}global.fetch=_nodeFetch2.default;class Helper{static ensureValidationDocumentPresence(e,n,t,a,d=!0){return(0,_asyncToGenerator3.default)(function*(){const i=_clientnode2.default.extendObject({_id:`_design/${n}`,language:'javascript'},t);try{const t=yield e.get(`_design/${n}`);i._rev=t._rev,yield e.put(i),d&&console.info(`${a} updated.`)}catch(n){d&&('not_found'===n.error?console.info(`${a} not available: create new one.`):console.info(`${a} couldn't be updated: "`+`${_clientnode2.default.representObject(n)}" create new one.`));try{yield e.put(i),d&&console.info(`${a} installed/updated.`)}catch(e){throw new Error(`${a} couldn't be installed/updated: "`+`${_clientnode2.default.representObject(e)}".`)}}})()}static initializeConnection(e,n){e.database.connection=new e.database.connector(_clientnode2.default.stringFormat(n.database.url,`${n.database.user.name}:`+`${n.database.user.password}@`)+`/${n.name}`,n.database.connector),e.database.connection.setMaxListeners(Infinity);const t=n.database.model.property.name.special.id,a=n.database.model.property.name.special.revision;for(const d of['post','put']){const i=e.database.connection[d].bind(e.database.connection);e.database.connection[d]=(()=>{var e=(0,_asyncToGenerator3.default)(function*(e,...d){try{return yield i(e,...d)}catch(d){if(t in e&&n.database.ignoreNoChangeError&&'name'in d&&'forbidden'===d.name&&'message'in d&&d.message.startsWith('NoChange:')){const n={id:e[t],ok:!0};try{n.rev=a in e&&!['latest','upsert'].includes(e[a])?e[a]:(yield this.get(n.id))[a]}catch(e){throw e}return n}throw d}});return function(){return e.apply(this,arguments)}})()}return e}static startServer(services,configuration){var _this=this;return(0,_asyncToGenerator3.default)(function*(){services.database.server.process=(0,_child_process.spawn)(services.database.server.binaryFilePath,['--config',configuration.database.configurationFilePath,'--dir',_path2.default.resolve(configuration.database.path),'--host',configuration.database['httpd/host'],'--port',`${configuration.database.port}`],{cwd:eval('process').cwd(),env:eval('process').env,shell:!0,stdio:'inherit'}),new _promise2.default(function(e,n){for(const t of _clientnode2.default.closeEventNames)services.database.server.process.on(t,_clientnode2.default.getProcessCloseHandler(e,n,{reason:t,process:services.database.server.process}))}).then(function(...e){services.database&&services.database.server&&services.database.server.resolve&&services.database.server.resolve.apply(_this,e)},function(...e){services.database&&services.database.server&&services.database.server.resolve&&services.database.server.reject.apply(_this,e)}),yield _clientnode2.default.checkReachability(_clientnode2.default.stringFormat(configuration.database.url,''),!0)})()}static restartServer(e,n,t){return(0,_asyncToGenerator3.default)(function*(){const a=e.database.server.resolve,d=e.database.server.reject;return e.database.server.resolve=e.database.server.reject=_clientnode2.default.noop,yield Helper.stopServer(e,n),e.database.server.resolve=a,e.database.server.reject=d,yield Helper.startServer(e,n),Helper.initializeConnection(e,n),yield _pluginAPI2.default.callStack('restartDatabase',t,n,e),e})()}static stopServer(e,n){return(0,_asyncToGenerator3.default)(function*(){return e.database.connection&&e.database.connection.close(),e.database.server.process&&e.database.server.process.kill('SIGINT'),yield _clientnode2.default.checkUnreachability(_clientnode2.default.stringFormat(n.database.url,''),!0),e})()}static determineAllowedModelRolesMapping(e){const n=e.property.name.special.allowedRole,t={},a=Helper.extendModels(e);for(const d in a)if(a.hasOwnProperty(d)&&a[d].hasOwnProperty(n))for(const e in t[d]=Helper.normalizeAllowedModelRoles(a[d][n]),t[d].properties={},a[d])a[d].hasOwnProperty(e)&&a[d][e].hasOwnProperty('allowedRoles')&&a[d][e].allowedRoles&&(t[d].properties[e]=Helper.normalizeAllowedModelRoles(a[d][e].allowedRoles));else t[d]={read:[],write:[],properties:{}};return t}static determineGenericIndexablePropertyNames(e,n){const t=e.property.name.special;return(0,_keys2.default)(n).filter((a)=>n[a].index||!(n[a].hasOwnProperty('index')&&!n[a].index||e.property.name.reserved.concat(t.additional,t.allowedRole,t.attachment,t.conflict,t.constraint.execution,t.constraint.expression,t.deleted,t.deleted_conflict,t.extend,t.id,t.maximumAggregatedSize,t.minimumAggregatedSize,t.revision,t.revisions,t.revisionsInformation,t.type).includes(a)||n[a].type&&('string'==typeof n[a].type&&n[a].type.endsWith('[]')||Array.isArray(n[a].type)&&n[a].type.length&&Array.isArray(n[a].type[0])||e.entities.hasOwnProperty(n[a].type)))).concat(t.id,t.revision)}static extendModel(e,n,t='_extends'){if('_base'===e)return n[e];if(n.hasOwnProperty('_base')&&(n[e].hasOwnProperty(t)?n[e][t]=['_base'].concat(n[e][t]):n[e][t]='_base'),n[e].hasOwnProperty(t)){for(const a of[].concat(n[e][t]))n[e]=_clientnode2.default.extendObject(!0,{},Helper.extendModel(a,n,t),n[e]);delete n[e][t]}return n[e]}static extendModels(e){const n=e.property.name.special,t={};for(const a in e.entities)if(e.entities.hasOwnProperty(a)){if(!(new RegExp(e.property.name.typeRegularExpressionPattern.public).test(a)||new RegExp(e.property.name.typeRegularExpressionPattern.private).test(a)))throw new Error('Model names have to match "'+e.property.name.typeRegularExpressionPattern.public+'" or "'+e.property.name.typeRegularExpressionPattern.private+`" for private one (given name: "${a}").`);t[a]=Helper.extendModel(a,e.entities,n.extend)}for(const a in t)if(t.hasOwnProperty(a))for(const d in t[a])if(t[a].hasOwnProperty(d))if(d===n.attachment)for(const n in t[a][d])t[a][d].hasOwnProperty(n)&&(t[a][d][n]=_clientnode2.default.extendObject(!0,_clientnode2.default.copy(e.property.defaultSpecification),t[a][d][n]));else[n.allowedRole,n.constraint.execution,n.constraint.expression,n.extend,n.maximumAggregatedSize,n.minimumAggregatedSize].includes(d)||(t[a][d]=_clientnode2.default.extendObject(!0,_clientnode2.default.copy(e.property.defaultSpecification),t[a][d]));return t}static normalizeAllowedModelRoles(e){if(Array.isArray(e))return{read:e,write:e};if('object'==typeof e){const n={read:[],write:[]};for(const t in n)e.hasOwnProperty(t)&&(n[t]=Array.isArray(e[t])?e[t]:[e[t]]);return n}return{read:[e],write:[e]}}}exports.Helper=Helper,exports.default=Helper},function(e){e.exports=require('child_process')},function(e){e.exports=require('node-fetch')},function(e){e.exports=require('web-node/pluginAPI.compiled')},function(e){e.exports=require('babel-runtime/core-js/json/stringify')},,function(e,n,t){e.exports=t(13)},function(module,exports,__webpack_require__){'use strict';function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}exports.__esModule=!0,exports.Database=void 0;var _symbol=__webpack_require__(14),_symbol2=_interopRequireDefault(_symbol),_stringify=__webpack_require__(10),_stringify2=_interopRequireDefault(_stringify),_promise=__webpack_require__(2),_promise2=_interopRequireDefault(_promise),_asyncToGenerator2=__webpack_require__(3),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_clientnode=__webpack_require__(4),_clientnode2=_interopRequireDefault(_clientnode),_fs=__webpack_require__(15),_fs2=_interopRequireDefault(_fs),_path=__webpack_require__(5),_path2=_interopRequireDefault(_path),_pouchdb=__webpack_require__(16),_pouchdb2=_interopRequireDefault(_pouchdb),_pouchdbFind=__webpack_require__(17),_pouchdbFind2=_interopRequireDefault(_pouchdbFind),_databaseHelper=__webpack_require__(18),_databaseHelper2=_interopRequireDefault(_databaseHelper),_helper=__webpack_require__(6),_helper2=_interopRequireDefault(_helper);try{__webpack_require__(0)}catch(e){}class Database{static loadService(servicePromises,services,configuration){return(0,_asyncToGenerator3.default)(function*(){let promise=null;if(services.database.server.hasOwnProperty('binaryFilePath')&&(yield _helper2.default.startServer(services,configuration),services.database.server.restart=_helper2.default.restartServer,services.database.server.start=_helper2.default.startServer,services.database.server.stop=_helper2.default.stopServer,promise=new _promise2.default(function(e,n){services.database.server.resolve=e,services.database.server.reject=n})),services.database.hasOwnProperty('connection'))return{promise};if(configuration.database.ensureAdminPresence){const e=new services.database.connector(`${_clientnode2.default.stringFormat(configuration.database.url,'')}/`+`_users`,configuration.database.connector);try{yield e.allDocs(),console.info('No admin user available. Automatically creating admin '+`user "${configuration.database.user.name}".`),yield fetch(`${_clientnode2.default.stringFormat(configuration.database.url,'')}/`+`_config/admins/${configuration.database.user.name}`,{method:'PUT',body:`"${configuration.database.user.password}"`})}catch(e){if(e.hasOwnProperty('name')&&'unauthorized'===e.name){const e=new services.database.connector(_clientnode2.default.stringFormat(configuration.database.url,`${configuration.database.user.name}:`+`${configuration.database.user.password}@`)+'/_users',configuration.database.connector);try{yield e.allDocs()}catch(e){console.error(`Can't login as existing admin user "`+`${configuration.database.user.name}": "`+`${_clientnode2.default.representObject(e)}".`)}finally{e.close()}}else console.error(`Can't create new admin user "`+`${configuration.database.user.name}": "`+`${_clientnode2.default.representObject(e)}".`)}finally{e.close()}}if(configuration.database.ensureUserPresence)for(const e of['admins','members'])for(const n of configuration.database.security[e].names){const t=new services.database.connector(_clientnode2.default.stringFormat(configuration.database.url,`${configuration.database.user.name}:`+`${configuration.database.user.password}@`)+'/_users',configuration.database.connector);try{yield t.get(`org.couchdb.user:${n}`)}catch(a){if(a.hasOwnProperty('error')&&'not_found'===a.error)try{yield t.put({[configuration.database.model.property.name.special.id]:`org.couchdb.user:${n}`,name:n,password:n,roles:[].concat(configuration.database.security[e].roles.includes(`${n}s`)?`${n}s`:[]),type:'user'})}catch(e){throw new Error(`Couldn't create missing user "${n}":`+` ${_clientnode2.default.representObject(e)}`)}else throw new Error(`Couldn't check for presence of user "`+`${n}": ${_clientnode2.default.representObject(a)}`)}finally{t.close()}}if(configuration.database.model.updateConfiguration)for(const e in configuration.database)if(configuration.database.hasOwnProperty(e)&&e.includes('/'))try{yield fetch(_clientnode2.default.stringFormat(configuration.database.url,`${configuration.database.user.name}:`+`${configuration.database.user.password}@`)+`/_config/${e}`,{method:'PUT',body:'"'+`${configuration.database[e]}"`})}catch(n){console.error(`Configuration "${e}" couldn't `+'be applied to "'+`${configuration.database[e]}": `+_clientnode2.default.representObject(n))}_helper2.default.initializeConnection(services,configuration);const idName=configuration.database.model.property.name.special.id,typeName=configuration.database.model.property.name.special.type;if(configuration.database.ensureSecuritySettingsPresence)try{yield fetch(_clientnode2.default.stringFormat(configuration.database.url,`${configuration.database.user.name}:`+`${configuration.database.user.password}@`)+`/${configuration.name}/_security`,{method:'PUT',headers:{"Content-Type":'application/json'},body:(0,_stringify2.default)(configuration.database.security)})}catch(e){console.error(`Security object couldn't be applied.: `+_clientnode2.default.representObject(e))}const modelConfiguration=_clientnode2.default.copy(configuration.database.model);delete modelConfiguration.property.defaultSpecification,delete modelConfiguration.entities;const models=_helper2.default.extendModels(configuration.database.model);if(configuration.database.model.updateValidation){const databaseHelperCode=yield new _promise2.default(function(resolve,reject){return _fs2.default.readFile(eval('require.resolve')('./databaseHelper.compiled'),{encoding:configuration.encoding,flag:'r'},function(e,n){return e?reject(e):resolve(n)})}),validationCode='function(...parameter) {\n'+`    return require('helper').default.validateDocumentUpdate`+'(...parameter.concat(['+(0,_stringify2.default)(models)+', '+(0,_stringify2.default)(modelConfiguration)+']))\n}';try{new Function(`return ${validationCode}`)}catch(e){throw new Error(`Generated validation code "${validationCode}" doesn't `+`compile: ${_clientnode2.default.representObject(e)}`)}configuration.debug&&console.info('Specification \n\n"'+_clientnode2.default.representObject(configuration.database.model)+`"\n\nhas generated validation code: \n\n"`+`${validationCode}".`),yield _helper2.default.ensureValidationDocumentPresence(services.database.connection,'validation',{helper:databaseHelperCode,validate_doc_update:validationCode},'Model specification');const authenticationCode='function(...parameter) {\n'+`    return require('helper').default.authenticate(`+'...parameter.concat(['+(0,_stringify2.default)(_helper2.default.determineAllowedModelRolesMapping(configuration.database.model))+`, '${idName}', '${typeName}']))\n`+'}';try{new Function(`return ${authenticationCode}`)}catch(e){throw new Error(`Generated authentication code "${authenticationCode}" `+`doesn't compile: ${_clientnode2.default.representObject(e)}`)}for(const e in configuration.debug&&console.info(`Authentication code "${authenticationCode}" generated.`),yield _helper2.default.ensureValidationDocumentPresence(services.database.connection,'authentication',{helper:databaseHelperCode,validate_doc_update:authenticationCode},'Authentication logic'),models)if(models.hasOwnProperty(e))for(const n in models[e])if(models[e].hasOwnProperty(n))if([modelConfiguration.property.name.special.constraint.execution,modelConfiguration.property.name.special.constraint.expression].includes(n)){for(const t of models[e][n])if(t.hasOwnProperty('description')&&t.description)try{new Function('return '+t.description)}catch(n){throw new Error(`Specified constraint `+`description "`+`${t.description}" `+`for model "${e}" `+`doesn't compile: "`+_clientnode2.default.representObject(n)+'".')}}else for(const t of['conflictingConstraintExpression','conflictingConstraintExecution','constraintExpression','constraintExecution'])if(models[e][n][t]&&models[e][n][t].hasOwnProperty('description'))try{new Function(models[e][n][t].description)}catch(a){throw new Error(`Specified constraint `+`description "`+models[e][n][t].description+`" for model "${e}" `+`in property "${n}" as "`+`${t}" doesn't compile: "`+_clientnode2.default.representObject(a)+'".')}}if(configuration.database.model.autoMigrationPath){if(yield _clientnode2.default.isDirectory(_path2.default.resolve(configuration.database.model.autoMigrationPath)))for(const e of yield _clientnode2.default.walkDirectoryRecursively(_path2.default.resolve(configuration.database.model.autoMigrationPath))){const n=_path2.default.extname(e.name),t=_path2.default.basename(e.name,n);if(configuration.database.model.entities.hasOwnProperty(t)&&'.json'===n)for(const n of JSON.parse((yield new _promise2.default(function(n,t){return _fs2.default.readFile(e.path,{encoding:configuration.encoding,flag:'r'},function(e,a){return e?t(e):n(a)})})))){n[typeName]=t;try{yield services.database.connection.put(n)}catch(e){throw new Error(`Migrating document "`+`${n[idName]}" of type "`+`${n[typeName]}" has failed: `+_clientnode2.default.representObject(e))}console.info(`Including document "`+`${n[idName]}" of type "`+`${n[typeName]}" was successful.`)}}for(const e of(yield services.database.connection.allDocs({include_docs:!0})).rows)if(!('string'==typeof e.id&&e.id.startsWith('_design/'))){const n=e.doc,t=_clientnode2.default.copy(n);t[configuration.database.model.property.name.special.strategy]='migrate';try{_databaseHelper2.default.validateDocumentUpdate(_clientnode2.default.copy(t),_clientnode2.default.copy(n),{db:configuration.name,name:configuration.database.user.name,roles:['_admin']},_clientnode2.default.copy(configuration.database.security),models,modelConfiguration)}catch(e){if('forbidden'in e){e.forbidden.startsWith('NoChange:')||console.warn(`Document "`+`${_clientnode2.default.representObject(n)}" `+`doesn't satisfy its schema (and can not`+` be migrated automatically): `+_clientnode2.default.representObject(e));continue}else throw e}try{yield services.database.connection.put(t)}catch(e){throw new Error(`Replaceing auto migrated document "`+`${t[idName]}" has failed: `+_clientnode2.default.representObject(e))}console.info(`Auto migrating document "${t[idName]}" `+'was successful.')}}if(configuration.database.createGenericFlatIndex&&configuration.database.model.autoMigrationPath){let e;try{e=(yield services.database.connection.getIndexes()).indexes}catch(e){throw e}for(const n in models)if(models.hasOwnProperty(n)&&new RegExp(configuration.database.model.property.name.typeRegularExpressionPattern.public).test(n))for(const t of _helper2.default.determineGenericIndexablePropertyNames(configuration.database.model,models[n])){const a=`${n}-${t}-GenericIndex`;let d=-1,i=0;for(const n of e){if(n.name===a){d=i;break}i+=1}if(-1==d)try{yield services.database.connection.createIndex({index:{ddoc:a,fields:[typeName,t],name:a}})}catch(e){throw e}else e.slice(i,1)}for(const n of e)if(n.name.endsWith('-GenericIndex')){let e=!1;for(const t in models)if(n.name.startsWith(`${t}-`)){for(const a of _helper2.default.determineGenericIndexablePropertyNames(configuration.database.model,models[t]))`${t}-${a}-GenericIndex`===n.name&&(e=!0);break}if(!e)try{yield services.database.connection.deleteIndex(n)}catch(e){throw e}}}return{name:'database',promise}})()}static preLoadService(e,n){return(0,_asyncToGenerator3.default)(function*(){if(!e.hasOwnProperty('database')){e.database={};try{__webpack_require__(22).Request.timeout=n.database.connector.ajax.timeout}catch(e){console.warn(`Couldn't find module "request" to synchronize timeout `+`option with pouchdb's one: `+_clientnode2.default.representObject(e))}}if(!e.database.hasOwnProperty('connector')){const t=n.database.model.property.name.special.id,a=n.database.model.property.name.special.revision;e.database.connector=_pouchdb2.default;const d=e.database.connector.prototype.bulkDocs;e.database.connector.plugin({bulkDocs:(()=>{var e=(0,_asyncToGenerator3.default)(function*(e,...i){const r=0<i.length&&i[i.length-1]===Database.toggleIDDetermining,o=r?!Database.skipIDDetermining:Database.skipIDDetermining;r&&i.pop(),!Array.isArray(e)&&'object'==typeof e&&null!==e&&t in e&&(e=[e]),n.database.connector.ajax&&n.database.connector.ajax.timeout&&(0===i.length||'object'!=typeof i[0])&&i.unshift({timeout:n.database.connector.ajax.timeout});let s=yield d.call(this,e,...i);const m=[],u=[];let l=0;for(const d of s){if('object'==typeof e[l]&&null!==e)if(a in e[l]&&'conflict'===d.name&&['latest','upsert'].includes(e[l][a]))u.push(d),m.push(l);else if(t in e[l]&&n.database.ignoreNoChangeError&&'name'in d&&'forbidden'===d.name&&'message'in d&&d.message.startsWith('NoChange:')&&(s[l]={id:e[l][t],ok:!0},!o))try{s[l].rev=a in e[l]&&!['latest','upsert'].includes(e[l][a])?e[l][a]:(yield this.get(s[l].id))[a]}catch(e){throw e}l+=1}if(u.length){e=u,r&&i.push(Database.toggleIDDetermining);const n=yield this.bulkDocs(e,...i);for(const e of n)s[m.shift()]=e}return s});return function(){return e.apply(this,arguments)}})()}),n.database.debug&&e.database.connector.debug.enable('*'),e.database.connector=e.database.connector.plugin(_pouchdbFind2.default)}if(!e.database.hasOwnProperty('server')){e.database.server={};for(const t of n.database.binary.locations){const a=_path2.default.resolve(t,n.database.binary.name);(yield _clientnode2.default.isFile(a))&&(e.database.server.binaryFilePath=a)}if(!e.database.server.hasOwnProperty('binaryFilePath'))throw new Error('No binary file name "'+`${n.database.binary.name}" in one of the `+'following locations found: "'+`${n.database.binary.locations.join('", "')}`+'".')}return e})()}static shouldExit(e,n){return(0,_asyncToGenerator3.default)(function*(){const t='log.txt';return(yield _clientnode2.default.isFile(t))&&(yield new _promise2.default(function(e,n){return _fs2.default.unlink(t,function(t){return t?n(t):e()})})),yield _helper2.default.stopServer(e,n),delete e.database,e})()}}exports.Database=Database,Database.skipIDDetermining=!0,Database.toggleIDDetermining=(0,_symbol2.default)('toggleIDDetermining'),exports.default=Database},function(e){e.exports=require('babel-runtime/core-js/symbol')},function(e){e.exports=require('fs')},function(e){e.exports=require('pouchdb')},function(e){e.exports=require('pouchdb-find')},function(e,n,t){'use strict';function a(e){return e&&e.__esModule?e:{default:e}}n.__esModule=!0,n.DatabaseHelper=void 0;var d=t(19),i=a(d),r=t(20),o=a(r),s=t(21),m=a(s),u=t(1),l=a(u),p=t(10),f=a(p);try{t(0)}catch(e){}class c{static authenticate(e,n,t={db:'dummy',name:'"unknown"',roles:[]},a={admins:{names:[],roles:[]},members:{names:[],roles:[]}},d,i,r,o=!1){if(!e.hasOwnProperty(r))return!0;const s={properties:{},read:['_admin','readonlyadmin'],write:['_admin']};e.hasOwnProperty(i)&&e[i].startsWith('_design/')&&s.read.push('readonlymember');let m=`Current user doesn't own any role`;const u=o?'read':'write';if(t){if('name'in t||(t.name='"unknown"'),d&&r&&e.hasOwnProperty(r)&&d.hasOwnProperty(e[r]))for(const n in s)s.hasOwnProperty(n)&&e.hasOwnProperty(r)&&(s[n]=Array.isArray(s[n])?s[n].concat(d[e[r]][n]):d[e[r]][n]);if(t.roles.length){const e=s[u];for(const n of t.roles)if(e.includes(n))return!0;m=`Current user "${t.name}" `+`owns the following roles: "`+`${t.roles.join('", "')}".`}else m=`Current user "${t.name}" `+`doesn't own any role`}throw{unauthorized:'Only users with a least on of these roles are allowed to '+`perform requested ${u} action: "`+`${s[u].join('", "')}". `+`${m}.`}}static validateDocumentUpdate(e,n,t={db:'dummy',name:'admin',roles:['_admin']},a={admins:{names:[],roles:[]},members:{names:[],roles:[]}},d,r,s=null){const u=new Date,p=Date.UTC(u.getUTCFullYear(),u.getUTCMonth(),u.getUTCDate(),u.getUTCHours(),u.getUTCMinutes(),u.getUTCSeconds(),u.getUTCMilliseconds())/1e3,c=r.property.name.special,y=c.id,h=c.revision,b=c.type;let g='',x='';const P=()=>{g=e.hasOwnProperty(y)?e[y]:'',x=e.hasOwnProperty(h)?e[h]:''};if(P(),a.hasOwnProperty(r.property.name.validatedDocumentsCache)&&a[r.property.name.validatedDocumentsCache].has(`${g}-${x}`))return a[r.property.name.validatedDocumentsCache].delete(`${g}-${x}`),e;if(['latest','upsert'].includes(x))if(n&&n.hasOwnProperty(h))x=e[h]=n[h];else if('latest'===x)throw{forbidden:'Revision: No old document available to update.'};else delete e[h];let w=r.updateStrategy;e.hasOwnProperty(c.strategy)&&(w=e[c.strategy],delete e[c.strategy]);let N;if(s)N=s;else if(JSON&&JSON.hasOwnProperty('stringify'))N=(e)=>(0,f.default)(e,null,4);else throw new Error('Needed "serialize" function is not available.');const v=(e,n)=>{if(n){for(const t in e)if(e.hasOwnProperty(t)&&t.startsWith(n))return t;}else{const n=(0,l.default)(e);if(n.length)return n[0]}return null},O=(e,n)=>{if(e.hasOwnProperty(c.attachment)){const t=v(e[c.attachment],n);if(t)return e[c.attachment][t].hasOwnProperty('stub')&&e[c.attachment][t].stub||e[c.attachment][t].hasOwnProperty('data')&&![void 0,null].includes(e[c.attachment][t].data)}return!1},C=(e,n,i=[])=>{const s=i.length?` in ${i.join(' -> ')}`:'';let f=[];const x=()=>{if(!e.hasOwnProperty(b))throw{forbidden:'Type: You have to specify a model type '+`via property "${b}"${s}.`};if(!(i.length||new RegExp(r.property.name.typeRegularExpressionPattern.public).test(e[b])))throw{forbidden:'TypeName: You have to specify a model type which matches "'+r.property.name.typeRegularExpressionPattern.public+`" as public type (given "`+`${e[b]}")${s}.`};if(!d.hasOwnProperty(e[b]))throw{forbidden:`Model: Given model "`+`${e[b]}" is not specified`+`${s}.`}};x();let D=e[b];const j=d[D];let S=null;j.hasOwnProperty(c.additional)&&j[c.additional]&&(S=j[c.additional]);const A=(o,f,c,y,h=['constraintExecution','constraintExpression'])=>{for(const b of h)if(c[b]){let h;const g=(b.endsWith('Expression')?'return ':'')+c[b].evaluation,x={attachmentWithPrefixExists:O.bind(e,e),checkDocument:C,checkPropertyContent:_,code:g,getFilenameByPrefix:v,model:j,modelConfiguration:r,modelName:D,models:d,name:f,newDocument:e,newValue:o,now:u,nowUTCTimestamp:p,oldDocument:n,oldValue:y,parentNames:i,pathDescription:s,propertySpecification:c,securitySettings:a,serialize:N,userContext:t};try{h=new Function(...(0,l.default)(x),g)}catch(e){throw{forbidden:`Compilation: Hook "${b}" has invalid`+` code "${g}": "${N(e)}`+`"${s}.`}}let P=!1;try{P=h(...(0,m.default)(x))}catch(e){throw{forbidden:`Runtime: Hook "${b}" has throw an `+`error with code "${g}": "`+`${N(e)}"${s}.`}}if(!P)throw{forbidden:b.charAt(0).toUpperCase()+b.substring(1)+`: `+(c[b].description?new Function(...(0,l.default)(x),'return '+c[b].description.trim())(...(0,m.default)(x)):`Property "${f}" should `+`satisfy constraint "${g}" (given "`+`${N(o)}")${s}.`)}}},_=(e,n,t,a=null)=>{let r=[];const m=Array.isArray(t.type)?t.type:[t.type];'object'==typeof e&&(0,o.default)(e)===Object.prototype&&!e.hasOwnProperty(b)&&1===m.length&&d.hasOwnProperty(m[0])&&(e[b]=m[0]);let u=!1;for(const l of m)if(d.hasOwnProperty(l)){if('object'==typeof e&&(0,o.default)(e)===Object.prototype&&e.hasOwnProperty(b)&&e[b]===l){const t=C(e,a,i.concat(n));if(t.changedPath.length&&(r=t.changedPath),e=t.newDocument,N(e)===N({}))return{newValue:null,changedPath:r};u=!0;break}else if(1===m.length)throw{forbidden:`NestedType: Under key "${n}" isn't `+`of type "${l}" (given "`+`${N(e)}" of type `+`${typeof e})${s}.`};}else if('DateTime'===l){const t=e;if(null!==e&&'number'!=typeof e&&(e=new Date(e),e=Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds())/1e3),!('number'!=typeof e||isNaN(e))){u=!0;break}else if(1===m.length)throw{forbidden:`PropertyType: Property "${n}" `+`isn't of (valid) type "DateTime" (`+`given "`+N(t).replace(/^"/,'').replace(/"$/,'')+`" of type "`+`${typeof t}")`+`${s}.`}}else if(['boolean','integer','number','string'].includes(l)){if(!('number'==typeof e&&isNaN(e)||'integer'!==l&&typeof e!==l||'integer'===l&&parseInt(e)!==e)){u=!0;break}else if(1===m.length)throw{forbidden:`PropertyType: Property "${n}"`+` isn't of (valid) type "${l}" (`+`given "${N(e)}" of `+`type "${typeof e}")`+`${s}.`};}else if('string'==typeof l&&l.startsWith('foreignKey:')){const t=d[l.substring(11)][y].type;if(t===typeof e){u=!0;break}else if(1===m.length)throw{forbidden:`PropertyType: Foreign key property "`+`${n}" isn't of type "`+`${t}" (given "`+`${N(e)}" of type "`+`${typeof e}")${s}.`}}else if('any'===l||N(e)===N(l)){u=!0;break}else if(1===m.length)throw{forbidden:`PropertyType: Property "${n}" isn't `+`value "${l}" (given "`+N(e).replace(/^"/,'').replace(/"$/,'')+`" of type "${typeof e}")`+`${s}.`};if(!u)throw{forbidden:'PropertyType: None of the specified types "'+`${m.join('", "')}" for property "${n}" `+`matches value "`+N(e).replace(/^"/,'').replace(/"$/,'')+`${e}" of type "${typeof e}")`+`${s}.`};if('string'==typeof e){if(![void 0,null].includes(t.minimumLength)&&e.length<t.minimumLength)throw{forbidden:`MinimalLength: Property "${n}" must have`+' minimal length '+`${t.minimumLength} (`+`given ${e} with length `+`${e.length})${s}.`};if(![void 0,null].includes(t.maximumLength)&&e.length>t.maximumLength)throw{forbidden:`MaximalLength: Property "${n}" must have`+' maximal length '+`${t.maximumLength} (`+`given ${e} with length `+`${e.length})${s}.`}}if('number'==typeof e){if(![void 0,null].includes(t.minimum)&&e<t.minimum)throw{forbidden:`Minimum: Property "${n}" (type `+`${t.type}) must `+'satisfy a minimum of '+`${t.minimum} (`+`given ${e} with length `+`${e.length})${s}.`};if(![void 0,null].includes(t.maximum)&&e>t.maximum)throw{forbidden:`Maximum: Property "${n}" (type `+`${t.type}) must `+'satisfy a maximum of '+`${t.maximum} (`+`given ${e} with length `+`${e.length}${s}.`}}if(t.selection&&!t.selection.includes(e))throw{forbidden:`Selection: Property "${n}" (type `+`${t.type}) should be one of`+' "'+t.selection.join('", "')+`". But is "${e}"${s}.`};if(!([void 0,null].includes(t.regularExpressionPattern)||new RegExp(t.regularExpressionPattern).test(e)))throw{forbidden:`PatternMatch: Property "${n}" should match `+'regular expression pattern '+t.regularExpressionPattern+` (given "${e}")${s}.`};else if(![void 0,null].includes(t.invertedRegularExpressionPattern)&&new RegExp(t.invertedRegularExpressionPattern).test(e))throw{forbidden:`InvertedPatternMatch: Property "${n}" should`+' not match regular expression pattern '+t.invertedRegularExpressionPattern+` (given "${e}")${s}.`};return A(e,n,t,a),N(e)!==N(a)&&(r=i.concat(n,'value updated')),{newValue:e,changedPath:r}},E=(e,n,i,o)=>{if(!i)for(const f of['onCreateExecution','onCreateExpression'])if(e[f]){let c;const y={attachmentWithPrefixExists:O.bind(n,n),checkDocument:C,checkPropertyContent:_,getFilenameByPrefix:v,model:j,modelConfiguration:r,modelName:D,models:d,name:o,newDocument:n,now:u,nowUTCTimestamp:p,oldDocument:i,propertySpecification:e,securitySettings:a,serialize:N,userContext:t};try{c=new Function(...(0,l.default)(y),(f.endsWith('Expression')?'return ':'')+e[f].trim())}catch(n){throw{forbidden:`Compilation: Hook "${f}" has `+'invalid code "'+`${e[f]}" for`+` property "${o}": `+N(n)+`${s}.`}}let h;try{h=c(...(0,m.default)(y))}catch(n){throw{forbidden:`Runtime: Hook "${f}" has throw `+'an error with code "'+`${e[f]}" `+`for property "${o}": `+N(n)+`${s}.`}}[void 0,null].includes(h)||(n[o]=h)}},T=(e,n,i,o)=>{if(n.hasOwnProperty(o)){e.trim&&'string'==typeof n[o]&&(n[o]=n[o].trim()),e.emptyEqualsToNull&&(''===n[o]||Array.isArray(n[o])&&0===n[o].length||'object'==typeof n[o]&&null!==n[o]&&0===(0,l.default)(n).length)&&(n[o]=null);for(const f of['onUpdateExecution','onUpdateExpression'])if(e[f]){let c;const y={attachmentWithPrefixExists:O.bind(n,n),checkDocument:C,checkPropertyContent:_,getFilenameByPrefix:v,model:j,modelConfiguration:r,modelName:D,models:d,name:o,newDocument:n,now:u,nowUTCTimestamp:p,oldDocument:i,propertySpecification:e,securitySettings:a,serialize:N,userContext:t};try{c=new Function(...(0,l.default)(y),(f.endsWith('Expression')?'return ':'')+e[f].trim())}catch(n){throw{forbidden:`Compilation: Hook "${f}" has invalid`+` code "${e[f]}" `+`for property "${o}": `+`${N(n)}${s}.`}}try{n[o]=c(...(0,m.default)(y))}catch(n){throw{forbidden:`Runtime: Hook "${f}" has throw an `+'error with code "'+`${e[f]}" for `+`property "${o}": ${N(n)}`+`${s}.`}}}}},z=(0,l.default)(j).filter((e)=>![c.additional,c.allowedRole,c.constraint.execution,c.constraint.expression,c.create.execution,c.create.expression,c.extend,c.maximumAggregatedSize,c.minimumAggregatedSize,c.update.execution,c.update.expression].includes(e));if(!n)for(const o of[r.property.name.special.create.execution,r.property.name.special.create.expression])if(j.hasOwnProperty(o)&&j[o]){let f;const c={attachmentWithPrefixExists:O.bind(e,e),checkDocument:C,checkPropertyContent:_,getFilenameByPrefix:v,model:j,modelConfiguration:r,modelName:D,models:d,id:g,newDocument:e,now:u,nowUTCTimestamp:p,oldDocument:n,securitySettings:a,serialize:N,userContext:t};try{f=new Function(...(0,l.default)(c),(o.endsWith('Expression')?'return ':'')+j[o].trim())}catch(e){throw{forbidden:`Compilation: Hook "${o}" has invalid`+` code "${j[o]}" for document "`+`${D}": ${N(e)}`+`${s}.`}}let y;try{y=f(...(0,m.default)(c))}catch(e){throw{forbidden:`Runtime: Hook "${o}" has throw an `+'error with code "'+`${j[o]}" for document "`+`${D}": ${N(e)}`+`${s}.`}}[void 0,null].includes(y)||(e=y),x(),D=e[b],0===i.length&&P()}for(const o of[r.property.name.special.update.execution,r.property.name.special.update.expression])if(j.hasOwnProperty(o)&&j[o]){let f;const c={attachmentWithPrefixExists:O.bind(e,e),checkDocument:C,checkPropertyContent:_,getFilenameByPrefix:v,model:j,modelConfiguration:r,modelName:D,models:d,id:g,newDocument:e,now:u,nowUTCTimestamp:p,oldDocument:n,securitySettings:a,serialize:N,userContext:t};try{f=new Function(...(0,l.default)(c),(o.endsWith('Expression')?'return ':'')+j[o].trim())}catch(e){throw{forbidden:`Compilation: Hook "${o}" has invalid `+` code "${j[o]}" for document "`+`${D}": ${N(e)}`+`${s}.`}}let y;try{y=f(...(0,m.default)(c))}catch(e){throw{forbidden:`Runtime: Hook "${o}" has throw an error `+`with code "${j[o]}" for document "`+`${D}": ${N(e)}`+`${s}.`}}[void 0,null].includes(y)||(e=y),x(),D=e[b],0===i.length&&P()}for(const t of z.concat(S?(0,l.default)(e).filter((e)=>!z.includes(e)):[]))if(c.attachment===t){for(const a in j[t])if(j[t].hasOwnProperty(a)){e.hasOwnProperty(t)&&null!==e[t]||(e[t]={}),n&&!n.hasOwnProperty(t)&&(n[t]={});const d=(0,l.default)(e[t]).filter((n)=>null!==e[t][n].data&&new RegExp(a).test(n));let r=[];n&&(r=(0,l.default)(n[t]).filter((d)=>!(e.hasOwnProperty(t)&&e[t].hasOwnProperty(d)&&e[t][d].hasOwnProperty('data')&&null===e[t][d].data)&&n[t][d]&&null!==n[t][d].data&&new RegExp(a).test(d)));for(const i of d)E(j[t][a],e[t],n&&n[t]?n[t]:null,i);for(const i of d)T(j[t][a],e[t],n&&n[t]?n[t]:null,i);if([void 0,null].includes(j[t][a].default)){if(!(j[t][a].nullable||0<d.length||0<r.length))throw{forbidden:'AttachmentMissing: Missing '+`attachment for type "${a}"`+`${s}.`};if('fillUp'===w&&0===d.length&&0<r.length)for(const a of r)null===e[t][a]?f=i.concat(t,a,'file removed'):e[t][a]=n[t][a]}else if(0===d.length)if(0===r.length)for(const n in j[t][a].default)j[t][a].default.hasOwnProperty(n)&&(e[t][n]=j[t][a].default[n],f=i.concat(t,a,'add default file'));else if('fillUp'===w)for(const a of r)e[t][a]=n[t][a]}}else{const a=z.includes(t)?j[t]:S;if(E(a,e,n,t),T(a,e,n,t),[void 0,null].includes(a.default)){if(!(a.nullable||e.hasOwnProperty(t)||n&&n.hasOwnProperty(t)&&w))throw{forbidden:'MissingProperty: Missing property "'+`${t}"${s}.`};!e.hasOwnProperty(t)&&n&&n.hasOwnProperty(t)&&('fillUp'===w?e[t]=n[t]:!w&&(f=i.concat(t,'property removed')))}else e.hasOwnProperty(t)&&null!==e[t]||(n&&n.hasOwnProperty(t)?'fillUp'===w?e[t]=n[t]:'migrate'===w&&(e[t]=a.default,f=i.concat(t,'migrate default value')):(e[t]=a.default,f=f.concat(t,'add default value')))}if(n&&'incremental'===w)for(const t in e)if(e.hasOwnProperty(t)&&n.hasOwnProperty(t)&&!r.property.name.reserved.concat(y,h,c.conflict,c.deleted,c.deletedConflict,c.localSequence,c.revisions,c.revisionsInformation,b).includes(t)&&(n[t]===e[t]||N(n[t])===N(e[t]))){delete e[t];continue}for(const t in e)if(e.hasOwnProperty(t)&&!r.property.name.reserved.concat(h,c.conflict,c.deleted,c.deletedConflict,c.localSequence,c.revisions,c.revisionsInformation,c.strategy).includes(t)){let a;if(j.hasOwnProperty(t))a=j[t];else if(S)a=S;else if('migrate'===w){delete e[t],f=i.concat(t,'migrate removed property');continue}else throw{forbidden:'Property: Given property "'+`${t}" isn't specified in `+`model "${D}"${s}.`};if(!a)continue;const m=(e,n,t,a)=>{if(!e.writable)if(t){if(t.hasOwnProperty(a)&&N(n[a])===N(t[a]))return a!==y&&'incremental'===w&&delete n[a],!0;throw{forbidden:'Readonly: Property "'+`${a}" is not writable (old `+`document "`+`${N(t)}")`+`${s}.`}}else throw{forbidden:`Readonly: Property "${a}"`+` is not writable${s}.`};if(!e.mutable&&t&&t.hasOwnProperty(a)){if(N(n[a])===N(t[a]))return'incremental'!==w||r.property.name.reserved.concat(c.deleted,y,h).includes(a)||delete n[a],!0;throw{forbidden:`Immutable: Property "${a}`+'" is not writable (old document "'+`${N(t)}")`+`${s}.`}}if(null===n[a]){if(e.nullable)return delete n[a],t&&t.hasOwnProperty(a)&&(f=i.concat(a,'delete property')),!0;throw{forbidden:`NotNull: Property "${a}" `+'should not by "null"'+`${s}.`}}return!1};if(c.attachment===t){for(const a in e[t])if(e[t].hasOwnProperty(a))for(const d in j[t])if(j[t].hasOwnProperty(d)&&new RegExp(d).test(a)){m(j[t][d],e,n,a);break}continue}else if(m(a,e,n,t))continue;if('string'==typeof a.type&&a.type.endsWith('[]')||Array.isArray(a.type)&&a.type.length&&Array.isArray(a.type[0])){if(!Array.isArray(e[t]))throw{forbidden:`PropertyType: Property "${t}" isn't `+`of type "array -> `+`${a.type}" (given "`+`${N(e[t])}")`+`${s}.`};else if(![void 0,null].includes(a.minimumNumber)&&e[t].length<a.minimumNumber)throw{forbidden:`MinimumArrayLength: Property "${t}" `+` (array of length `+`${e[t].length}) doesn't `+`fullfill minimum array length of `+a.minimumNumber+`${s}.`};else if(![void 0,null].includes(a.maximumNumber)&&a.maximumNumber<e[t].length)throw{forbidden:`MaximumArrayLength: Property "${t}" `+`(array of length `+`${e[t].length}) doesn't `+`fullfill maximum array length of `+a.maximumNumber+`${s}.`};A(e[t],t,a,n&&n.hasOwnProperty(t)&&n[t]||void 0,['arrayConstraintExecution','arrayConstraintExpression']);const r={};for(const e in a)a.hasOwnProperty(e)&&(r[e]='type'===e?Array.isArray(a[e])?a[e][0]:[a[e].substring(0,a.type.length-2)]:a[e]);if(1===typeof r.type.length&&d.hasOwnProperty(r.type[0]))for(const n of e[t].slice())'object'!=typeof n||(0,o.default)(n)!==Object.prototype||n.hasOwnProperty(b)||(n[b]=r.type[0]);let m=0;for(const n of e[t].slice())e[t][m]=_(n,`${m+1}. value in ${t}`,r).newValue,null===n&&e[t].splice(m,1),m+=1;n&&n.hasOwnProperty(t)&&Array.isArray(n[t])&&n[t].length===e[t].length&&N(n[t])===N(e[t])||(f=i.concat(t,'array updated'))}else{const d=n&&n.hasOwnProperty(t)?n[t]:null,r=_(e[t],t,a,d);e[t]=r.newValue,r.changedPath.length&&(f=r.changedPath),null===e[t]&&(null!==d&&(f=i.concat(t,'property removed')),delete e[t])}}for(let o in c.constraint)if(c.constraint.hasOwnProperty(o)&&(o=c.constraint[o])&&j.hasOwnProperty(o)&&Array.isArray(j[o])&&j[o].length)for(const f of j[o]){let y;const h=(o===c.constraint.expression?'return ':'')+f.evaluation.trim(),b={attachmentWithPrefixExists:O.bind(e,e),checkDocument:C,checkPropertyContent:_,code:h,getFilenameByPrefix:v,model:j,modelConfiguration:r,modelName:D,models:d,newDocument:e,now:u,nowUTCTimestamp:p,oldDocument:n,parentNames:i,pathDescription:s,securitySettings:a,serialize:N,userContext:t};try{y=new Function(...(0,l.default)(b),h)}catch(e){throw{forbidden:`Compilation: Hook "${o}" has `+`invalid code "${h}": "`+N(e)+`"${s}.`}}let g=!1;try{g=y(...(0,m.default)(b))}catch(e){throw{forbidden:`Runtime: Hook "${o}" has `+`thrown an error with code "${h}": `+`${N(e)}${s}.`}}if(!g){const n=o.replace(/^[^a-zA-Z]+/,'');throw{forbidden:n.charAt(0).toUpperCase()+`${n.substring(1)}: `+(f.description?new Function(...(0,l.default)(b),'return '+f.description.trim())(...(0,m.default)(b)):`Model "${D}" should satisfy `+`constraint "${h}" (given "`+`${N(e)}")`+`${s}.`)}}}if(e.hasOwnProperty(c.attachment)){const t=e[c.attachment];if('object'!=typeof t||(0,o.default)(t)!==Object.prototype)throw{forbidden:'AttachmentType: given attachment has '+`invalid type${s}.`};let a=null;if(n&&n.hasOwnProperty(c.attachment)&&(a=n[c.attachment],null!==a&&'object'==typeof a))for(const e in a)a.hasOwnProperty(e)&&(t.hasOwnProperty(e)?null===t[e]||null===t[e].data||t[e].content_type===a[e].content_type&&t[e].data===a[e].data?((null===t[e]||null===t[e].data)&&(f=i.concat(c.attachment,e,'attachment removed')),'incremental'===w&&delete t[e]):f=i.concat(c.attachment,e,'attachment updated'):'fillUp'===w?t[e]=a[e]:w||(f=i.concat(c.attachment,e,'attachment removed')));for(const e in t)t.hasOwnProperty(e)&&([void 0,null].includes(t[e])||null===t[e].data?delete t[e]:a&&a.hasOwnProperty(e)&&t[e].content_type===a[e].content_type&&t[e].data===a[e].data||(f=i.concat(c.attachment,e,'attachment updated')));0===(0,l.default)(t).length&&delete e[c.attachment];const d={};for(const e in j[c.attachment])j[c.attachment].hasOwnProperty(e)&&(d[e]=[]);for(const e in t)if(t.hasOwnProperty(e)){let n=!1;for(const t in j[c.attachment])if(new RegExp(t).test(e)){d[t].push(e),n=!0;break}if(!n)throw{forbidden:'AttachmentTypeMatch: None of the specified attachment types ("'+(0,l.default)(j[c.attachment]).join('", "')+'") matches given one '+`("${e}")${s}.`}}let r=0;for(const e in d){if(!d.hasOwnProperty(e))continue;const n=d[e].length;if(null!==j[c.attachment][e].maximumNumber&&n>j[c.attachment][e].maximumNumber)throw{forbidden:'AttachmentMaximum: given number of '+`attachments (${n}) `+`doesn't satisfy specified maximum of `+j[c.attachment][e].maximumNumber+` from type "${e}"${s}.`};if(!(j[c.attachment][e].nullable&&0===n)&&n<j[c.attachment][e].minimumNumber)throw{forbidden:'AttachmentMinimum: given number of '+`attachments (${n}) `+`doesn't satisfy specified minimum of `+j[c.attachment][e].minimumNumber+` from type "${e}"${s}.`};let a=0;for(const n of d[e]){if(!([null,void 0].includes(j[c.attachment][e].regularExpressionPattern)||new RegExp(j[c.attachment][e].regularExpressionPattern).test(n)))throw{forbidden:'AttachmentName: given attachment name "'+`${n}" doesn't satisfy specified `+'regular expression pattern "'+j[c.attachment][e].regularExpressionPattern+`" from type "${e}"${s}.`};else if(![null,void 0].includes(j[c.attachment][e].invertedRegularExpressionPattern)&&new RegExp(j[c.attachment][e].invertedRegularExpressionPattern).test(n))throw{forbidden:'InvertedAttachmentName: given '+`attachment name "${n}" doesn't `+'satisfy specified regular expression pattern "'+j[c.attachment][e].invertedRegularExpressionPattern+`" from type "${e}"${s}.`};else if(!([null,void 0].includes(j[c.attachment][e].contentTypeRegularExpressionPattern)||t[n].hasOwnProperty('content_type')&&t[n].content_type&&new RegExp(j[c.attachment][e].contentTypeRegularExpressionPattern).test(t[n].content_type)))throw{forbidden:'AttachmentContentType: given attachment content type "'+t[n].content_type+`" doesn't satisfy specified regular`+' expression pattern "'+j[c.attachment][e].contentTypeRegularExpressionPattern+`" from type "${e}"${s}.`};const d=j[c.attachment][e].invertedContentTypeRegularExpressionPattern;if(!([null,void 0].includes(d)||t[n].hasOwnProperty('content_type')&&t[n].content_type&&!new RegExp(d).test(t[n].content_type)))throw{forbidden:'InvertedAttachmentContentType: given attachment content type "'+t[n].content_type+`" doesn't satisfy specified regular`+` expression pattern "${d}" `+`from type "${e}"${s}.`};let i=0;if('length'in t[n]?i=t[n].length:'data'in t[n]&&(Buffer&&'byteLength'in Buffer?i=Buffer.byteLength(t[n].data,'base64'):i=t.data.length),![null,void 0].includes(j[c.attachment][e].minimumSize)&&j[c.attachment][e].minimumSize>i)throw{forbidden:'AttachmentMinimumSize: given attachment'+` size ${i} byte doesn't satisfy `+'specified minimum  of '+j[c.attachment][e].minimumSize+` byte ${s}.`};else if(![null,void 0].includes(j[c.attachment][e].maximumSize)&&j[c.attachment][e].maximumSize<i)throw{forbidden:'AttachmentMaximumSize: given attachment'+` size ${i} byte doesn't satisfy `+'specified maximum of '+j[c.attachment][e].maximumSize+` byte ${s}.`};a+=i}if(![null,void 0].includes(j[c.attachment][e].minimumAggregatedSize)&&j[c.attachment][e].minimumAggregatedSize>a)throw{forbidden:'AttachmentAggregatedMinimumSize: given  aggregated size of attachments from type "'+`${e}" ${a} byte doesn't `+'satisfy specified minimum of '+j[c.attachment][e].minimumAggregatedSize+` byte ${s}.`};else if(![null,void 0].includes(j[c.attachment][e].maximumAggregatedSize)&&j[c.attachment][e].maximumAggregatedSize<a)throw{forbidden:'AttachmentAggregatedMaximumSize: given  aggregated size of attachments from type "'+`${e}" ${a} byte doesn't `+'satisfy specified maximum of '+j[c.attachment][e].maximumAggregatedSize+` byte ${s}.`};r+=a}if(j.hasOwnProperty(c.minimumAggregatedSize)&&![null,void 0].includes(j[c.minimumAggregatedSize])&&j[c.minimumAggregatedSize]>r)throw{forbidden:'AggregatedMinimumSize: given aggregated size '+`${r} byte doesn't satisfy `+'specified minimum of '+j[c.minimumAggregatedSize]+` byte ${s}.`};else if(j.hasOwnProperty(c.maximumAggregatedSize)&&![null,void 0].includes(j[c.maximumAggregatedSize])&&j[c.maximumAggregatedSize]<r)throw{forbidden:'AggregatedMaximumSize: given aggregated size '+`${r} byte doesn't satisfy `+'specified maximum of '+j[c.maximumAggregatedSize]+` byte ${s}.`}}if(n&&n.hasOwnProperty(c.attachment)&&0===(0,l.default)(n[c.attachment]).length&&delete n[c.attachment],0===f.length&&n&&'migrate'===w)for(const t in n)n.hasOwnProperty(t)&&!e.hasOwnProperty(t)&&(f=i.concat(t,'migrate removed property'));return{changedPath:f,newDocument:e}},D=C(e,n);if(D.newDocument._deleted&&!n||!(D.newDocument._deleted&&n&&D.newDocument._deleted!==n._deleted||D.changedPath.length))throw{forbidden:'NoChange: No new data given. new document: '+`${N(e)}; old document: `+`${N(n)}.`};return a.hasOwnProperty('checkedDocuments')?a[r.property.name.validatedDocumentsCache].add(`${g}-${x}`):a[r.property.name.validatedDocumentsCache]=new i.default([`${g}-${x}`]),D.newDocument}}n.DatabaseHelper=c,n.default=c},function(e){e.exports=require('babel-runtime/core-js/set')},function(e){e.exports=require('babel-runtime/core-js/object/get-prototype-of')},function(e){e.exports=require('babel-runtime/core-js/object/values')},function(e){e.exports=require('request')}]);