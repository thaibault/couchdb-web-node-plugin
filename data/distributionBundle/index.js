(()=>{var __webpack_modules__=[e=>{"use strict";e.exports=require("@babel/runtime/helpers/extends")},e=>{"use strict";e.exports=require("@babel/runtime/helpers/asyncToGenerator")},e=>{"use strict";e.exports=require("@babel/runtime/regenerator")},e=>{"use strict";e.exports=require("clientnode")},e=>{"use strict";e.exports=require("fs")},e=>{"use strict";e.exports=require("path")},e=>{"use strict";e.exports=require("child_process")},e=>{"use strict";e.exports=require("pouchdb/node_modules/node-fetch/lib/index.js")},,(module,__unused_webpack_exports,__webpack_require__)=>{(function(){function __nested_webpack_require_12__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var r=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](r,r.exports,__nested_webpack_require_12__),r.exports}var __webpack_modules__=[function(e){"use strict";e.exports=__webpack_require__(0)},function(e){"use strict";e.exports=__webpack_require__(1)},function(e){"use strict";e.exports=__webpack_require__(2)},function(e){"use strict";e.exports=__webpack_require__(3)},function(e){"use strict";e.exports=__webpack_require__(4)},function(e){"use strict";e.exports=__webpack_require__(5)},function(e){"use strict";e.exports=__webpack_require__(6)},function(e){"use strict";e.exports=__webpack_require__(7)},function(__unused_webpack_module,__webpack_exports__,__nested_webpack_require_859__){"use strict";function _createForOfIteratorHelperLoose(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}__nested_webpack_require_859__.d(__webpack_exports__,{default:function(){return __WEBPACK_DEFAULT_EXPORT__}});var _babel_runtime_helpers_extends__WEBPACK_IMPORTED_MODULE_0__=__nested_webpack_require_859__(0),_babel_runtime_helpers_extends__WEBPACK_IMPORTED_MODULE_0___default=__nested_webpack_require_859__.n(_babel_runtime_helpers_extends__WEBPACK_IMPORTED_MODULE_0__),_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_1__=__nested_webpack_require_859__(1),_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_1___default=__nested_webpack_require_859__.n(_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_1__),_babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2__=__nested_webpack_require_859__(2),_babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default=__nested_webpack_require_859__.n(_babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2__),child_process__WEBPACK_IMPORTED_MODULE_3__=__nested_webpack_require_859__(6),child_process__WEBPACK_IMPORTED_MODULE_3___default=__nested_webpack_require_859__.n(child_process__WEBPACK_IMPORTED_MODULE_3__),clientnode__WEBPACK_IMPORTED_MODULE_4__=__nested_webpack_require_859__(3),clientnode__WEBPACK_IMPORTED_MODULE_4___default=__nested_webpack_require_859__.n(clientnode__WEBPACK_IMPORTED_MODULE_4__),node_fetch__WEBPACK_IMPORTED_MODULE_5__=__nested_webpack_require_859__(7),node_fetch__WEBPACK_IMPORTED_MODULE_5___default=__nested_webpack_require_859__.n(node_fetch__WEBPACK_IMPORTED_MODULE_5__),fs__WEBPACK_IMPORTED_MODULE_6__=__nested_webpack_require_859__(4),fs__WEBPACK_IMPORTED_MODULE_6___default=__nested_webpack_require_859__.n(fs__WEBPACK_IMPORTED_MODULE_6__),path__WEBPACK_IMPORTED_MODULE_7__=__nested_webpack_require_859__(5),path__WEBPACK_IMPORTED_MODULE_7___default=__nested_webpack_require_859__.n(path__WEBPACK_IMPORTED_MODULE_7__);clientnode__WEBPACK_IMPORTED_MODULE_4__.globalContext.fetch=node_fetch__WEBPACK_IMPORTED_MODULE_5___default();var Helper=function(){function Helper(){}return Helper.getConnectorOptions=function(e){return e.couchdb.connector.fetch?{fetch:function(t,r){return clientnode__WEBPACK_IMPORTED_MODULE_4__.globalContext.fetch(t,clientnode__WEBPACK_IMPORTED_MODULE_4___default().extend(!0,clientnode__WEBPACK_IMPORTED_MODULE_4___default().copy(e.couchdb.connector.fetch),r||{}))}}:{fetch:function(e,t){return clientnode__WEBPACK_IMPORTED_MODULE_4__.globalContext.fetch(e,t)}}},Helper.mayStripRepresentation=function(e,t,r){var n=clientnode__WEBPACK_IMPORTED_MODULE_4___default().represent(e);return n.length<=t?n.length>r?n.substring(0,r-3)+"...":n:"DOCUMENT IS TOO BIG TO REPRESENT"},Helper.ensureValidationDocumentPresence=(t=_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_1___default()(_babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().mark((function e(t,r,n,o,a,_,c){var i,s,l;return _babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===a&&(a=!0),void 0===_&&(_="_id"),void 0===c&&(c="_design/"),s=_babel_runtime_helpers_extends__WEBPACK_IMPORTED_MODULE_0___default()(((i={})[_]=""+c+r,i.language="javascript",i),n),e.prev=4,e.next=7,t.get(""+c+r);case 7:return l=e.sent,s._rev=l._rev,e.next=11,t.put(s);case 11:case 20:e.next=26;break;case 14:return e.prev=14,e.t0=e.catch(4),a&&e.t0.error,e.prev=17,e.next=20,t.put(s);case 23:throw e.prev=23,e.t1=e.catch(17),new Error(o+" couldn't be installed/updated: \""+clientnode__WEBPACK_IMPORTED_MODULE_4___default().represent(e.t1)+'".');case 26:case"end":return e.stop()}}),e,null,[[4,14],[17,23]])}))),function(){return t.apply(this,arguments)}),Helper.initializeConnection=function(){var e=_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_1___default()(_babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().mark((function e(t,r){var n,o,a,_,c,i;return _babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(n=clientnode__WEBPACK_IMPORTED_MODULE_4___default().stringFormat(r.couchdb.url,r.couchdb.user.name+":"+r.couchdb.user.password+"@")+"/"+r.couchdb.databaseName,t.couchdb.connection=new t.couchdb.connector(n,Helper.getConnectorOptions(r)),t.couchdb.connection.setMaxListeners(1/0),o=r.couchdb.model.property.name.special.id,a=r.couchdb.model.property.name.special.revision,_=function(){var e=i.value,n=t.couchdb.connection[e].bind(t.couchdb.connection);t.couchdb.connection[e]=_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_1___default()(_babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().mark((function e(t){var _,c,i,s,l,u=arguments;return _babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(e.prev=0,_=u.length,c=Array(1<_?_-1:0),i=1;i<_;i++)c[i-1]=u[i];return e.next=4,n.apply(void 0,[t].concat(c));case 4:return e.abrupt("return",e.sent);case 7:if(e.prev=7,e.t0=e.catch(0),!(o in t&&r.couchdb.ignoreNoChangeError&&"forbidden"===e.t0.name&&null!=(s=e.t0.message)&&s.startsWith("NoChange:"))){e.next=21;break}if(l={id:t[o],ok:!0},!(a in t)||["latest","upsert"].includes(t[a])){e.next=15;break}e.t1=t[a],e.next=19;break;case 15:return e.next=17,this.get(l.id);case 17:e.t2=a,e.t1=e.sent[e.t2];case 19:return l.rev=e.t1,e.abrupt("return",l);case 21:throw e.t0;case 22:case"end":return e.stop()}}),e,this,[[0,7]])})))},c=_createForOfIteratorHelperLoose(["post","put"]);!(i=c()).done;)_();return e.prev=7,e.next=10,clientnode__WEBPACK_IMPORTED_MODULE_4___default().checkReachability(n);case 10:e.next=17;break;case 12:return e.prev=12,e.t0=e.catch(7),e.next=17,clientnode__WEBPACK_IMPORTED_MODULE_4__.globalContext.fetch(n,{method:"PUT"});case 17:return e.abrupt("return",t);case 18:case"end":return e.stop()}}),e,null,[[7,12]])})));return function(){return e.apply(this,arguments)}}(),Helper.startServer=function(){function startServer(){return _startServer.apply(this,arguments)}var _startServer=_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_1___default()(_babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().mark((function _callee4(services,configuration){var _this=this;return _babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().wrap((function(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:if(!Object.prototype.hasOwnProperty.call(services.couchdb.server.runner,"configurationFile")){_context4.next=12;break}return _context4.prev=1,_context4.next=4,fs__WEBPACK_IMPORTED_MODULE_6__.promises.mkdir(path__WEBPACK_IMPORTED_MODULE_7___default().dirname(services.couchdb.server.runner.configurationFile.path),{recursive:!0});case 4:_context4.next=10;break;case 6:if(_context4.prev=6,_context4.t0=_context4.catch(1),"EEXIST"===_context4.t0.code){_context4.next=10;break}throw _context4.t0;case 10:return _context4.next=12,fs__WEBPACK_IMPORTED_MODULE_6__.promises.writeFile(services.couchdb.server.runner.configurationFile.path,services.couchdb.server.runner.configurationFile.content,{encoding:configuration.core.encoding});case 12:return services.couchdb.server.process=(0,child_process__WEBPACK_IMPORTED_MODULE_3__.spawn)("default"===configuration.couchdb.binary.memoryInMegaByte?services.couchdb.server.runner.binaryFilePath:configuration.couchdb.binary.nodePath,("default"===configuration.couchdb.binary.memoryInMegaByte?[]:["--max-old-space-size="+configuration.couchdb.binary.memoryInMegaByte,services.couchdb.server.runner.binaryFilePath]).concat(services.couchdb.server.runner.arguments?services.couchdb.server.runner.arguments:[]),{cwd:eval("process").cwd(),env:Object.prototype.hasOwnProperty.call(services.couchdb.server.runner,"environment")?_babel_runtime_helpers_extends__WEBPACK_IMPORTED_MODULE_0___default()({},eval("process").env,services.couchdb.server.runner.environment):eval("process").env,shell:!0,stdio:"inherit"}),new Promise((function(e,t){for(var r,n,o=_createForOfIteratorHelperLoose(clientnode__WEBPACK_IMPORTED_MODULE_4__.CloseEventNames);!(r=o()).done;)n=r.value,services.couchdb.server.process.on(n,clientnode__WEBPACK_IMPORTED_MODULE_4___default().getProcessCloseHandler(e,t,{process:services.couchdb.server.process,reason:n}))})).then((function(e){var t,r;null!=(t=services.couchdb)&&null!=(r=t.server)&&r.resolve&&services.couchdb.server.resolve.call(_this,e)}),(function(e){var t,r;null!=(t=services.couchdb)&&null!=(r=t.server)&&r.resolve&&services.couchdb.server.reject.call(_this,e)})),_context4.next=16,clientnode__WEBPACK_IMPORTED_MODULE_4___default().checkReachability(clientnode__WEBPACK_IMPORTED_MODULE_4___default().stringFormat(configuration.couchdb.url,""),{wait:!0});case 16:case"end":return _context4.stop()}}),_callee4,null,[[1,6]])})));return startServer}(),Helper.restartServer=function(){var e=_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_1___default()(_babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().mark((function e(t){var r,n,o,a,_,c;return _babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.configuration,n=t.pluginAPI,o=t.services,a=o.couchdb.server,_=a.resolve,c=a.reject,a.resolve=a.reject=clientnode__WEBPACK_IMPORTED_MODULE_4___default().noop,e.next=7,Helper.stopServer(o,r);case 7:return a.resolve=_,a.reject=c,e.next=11,Helper.startServer(o,r);case 11:return Helper.initializeConnection(o,r),e.next=14,n.callStack(_babel_runtime_helpers_extends__WEBPACK_IMPORTED_MODULE_0___default()({},t,{hook:"restartCouchdb"}));case 14:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),Helper.stopServer=function(){var e=_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_1___default()(_babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().mark((function e(t,r){var n,o;return _babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.couchdb,o=r.couchdb,n.connection&&n.connection.close(),n.server.process&&n.server.process.kill("SIGINT"),e.next=6,clientnode__WEBPACK_IMPORTED_MODULE_4___default().checkUnreachability(clientnode__WEBPACK_IMPORTED_MODULE_4___default().stringFormat(o.url,""),{wait:!0});case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),Helper.determineAllowedModelRolesMapping=function(e){for(var t=e.property.name.special.allowedRole,r={},n=Helper.extendModels(e),o=0,a=Object.entries(n);o<a.length;o++){var _=a[o],c=_[0],i=_[1];if(Object.prototype.hasOwnProperty.call(i,t)){r[c]=_babel_runtime_helpers_extends__WEBPACK_IMPORTED_MODULE_0___default()({properties:{}},Helper.normalizeAllowedRoles(i[t]));for(var s=0,l=Object.entries(i);s<l.length;s++){var u=l[s],p=u[0],d=u[1];null!==d&&"object"==typeof d&&d.allowedRoles&&(r[c].properties[p]=Helper.normalizeAllowedRoles(d.allowedRoles))}}else r[c]={properties:{},read:[],write:[]}}return r},Helper.determineGenericIndexablePropertyNames=function(e,t){var r=e.property.name.special;return Object.keys(t).filter((function(n){return null!==t[n]&&"object"==typeof t[n]&&(Object.prototype.hasOwnProperty.call(t[n],"index")&&t[n].index||!(Object.prototype.hasOwnProperty.call(t[n],"index")&&!t[n].index||e.property.name.reserved.concat(r.additional,r.allowedRole,r.attachment,r.conflict,r.constraint.execution,r.constraint.expression,r.deleted,r.deletedConflict,r.extend,r.id,r.maximumAggregatedSize,r.minimumAggregatedSize,r.oldType,r.revision,r.revisions,r.revisionsInformation,r.type).includes(n)||t[n].type&&("string"==typeof t[n].type&&t[n].type.endsWith("[]")||Array.isArray(t[n].type)&&t[n].type.length&&Array.isArray(t[n].type[0])||Object.prototype.hasOwnProperty.call(e.entities,t[n].type))))})).concat(r.id,r.revision).sort()},Helper.extendModel=function(e,t,r){if(void 0===r&&(r="_extends"),"_base"===e)return t[e];if(Object.prototype.hasOwnProperty.call(t,"_base")&&(Object.prototype.hasOwnProperty.call(t[e],r)&&t[e][r]?t[e][r]=["_base"].concat(t[e][r]):t[e][r]="_base"),Object.prototype.hasOwnProperty.call(t[e],r)){for(var n,o,a=_createForOfIteratorHelperLoose([].concat(t[e][r]));!(n=a()).done;)o=n.value,t[e]=clientnode__WEBPACK_IMPORTED_MODULE_4___default().extend(!0,clientnode__WEBPACK_IMPORTED_MODULE_4___default().copy(Helper.extendModel(o,t,r)),t[e]);delete t[e][r]}return t[e]},Helper.extendModels=function(e){for(var t,r=e.property.name.special,n={},o=0,a=Object.keys(e.entities);o<a.length;o++){if(t=a[o],!new RegExp(e.property.name.typeRegularExpressionPattern.public).test(t)&&!new RegExp(e.property.name.typeRegularExpressionPattern.private).test(t))throw new Error('Model names have to match "'+e.property.name.typeRegularExpressionPattern.public+'" or "'+e.property.name.typeRegularExpressionPattern.private+'" for private one (given name: "'+t+'").');n[t]=Helper.extendModel(t,e.entities,r.extend)}for(var _,c=0,i=Object.values(n);c<i.length;c++){_=i[c];for(var s=0,l=Object.entries(_);s<l.length;s++){var u=l[s],p=u[0],d=u[1];if(p===r.attachment)for(var f=0,m=Object.entries(d);f<m.length;f++){var b=m[f],h=b[0],y=b[1];d[h]=clientnode__WEBPACK_IMPORTED_MODULE_4___default().extend(!0,clientnode__WEBPACK_IMPORTED_MODULE_4___default().copy(e.property.defaultSpecification),y)}else[r.allowedRole,r.constraint.execution,r.constraint.expression,r.extend,r.maximumAggregatedSize,r.minimumAggregatedSize,r.oldType].includes(p)||(_[p]=clientnode__WEBPACK_IMPORTED_MODULE_4___default().extend(!0,clientnode__WEBPACK_IMPORTED_MODULE_4___default().copy(e.property.defaultSpecification),d))}}return n},Helper.normalizeAllowedRoles=function(e){if(Array.isArray(e))return{read:e,write:e};if("object"==typeof e){for(var t,r={read:[],write:[]},n=0,o=Object.keys(r);n<o.length;n++)t=o[n],Object.prototype.hasOwnProperty.call(e,t)&&(Array.isArray(e[t])?r[t]=e[t]:r[t]=[e[t]]);return r}return{read:[e],write:[e]}},Helper;var t}(),__WEBPACK_DEFAULT_EXPORT__=Helper},function(e){!function(){"use strict";function t(){return(t=r()?Reflect.construct.bind():function(e,t,r){var o=[null];o.push.apply(o,t);var a=new(Function.bind.apply(e,o));return r&&n(a,r.prototype),a}).apply(null,arguments)}function r(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function n(e,t){return n=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},n(e,t)}function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t,r=1;r<arguments.length;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},o.apply(this,arguments)}function a(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return _(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}var c={d:function(e,t){for(var r in t)c.o(t,r)&&!c.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o:function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r:function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},i={};c.r(i),c.d(i,{DatabaseHelper:function(){return s},default:function(){return l}});var s=function(){function e(){}return e.authenticate=function(e,t,r,n,o,_,c,i,s){var l;void 0===t&&(t=null),void 0===r&&(r={}),void 0===n&&(n={admins:{names:[],roles:[]},members:{names:[],roles:[]}}),void 0===_&&(_="_id"),void 0===c&&(c="-type"),void 0===i&&(i="_design/"),void 0===s&&(s=!1);var u=null!==(l=e[c])&&void 0!==l?l:t&&t[c];if(!u)return!0;var p=s?"read":"write",d={properties:{},read:["_admin","readonlyadmin"],write:["_admin"]};Object.prototype.hasOwnProperty.call(e,_)&&e[_].startsWith(i)&&d.read.push("readonlymember");var f,m="Current user doesn't own any role";if(r)if("name"in r||(r.name='"unknown"'),null!=(f=r.roles)&&f.length){if(o&&u&&Object.prototype.hasOwnProperty.call(o,u)){for(var b,h,y=o[u],O=a(["read","write"]);!(b=O()).done;)d[h=b.value]=d[h].concat(y[h]||[]);d.properties=y.properties}for(var x,g,E=d[p],P=a(r.roles);!(x=P()).done;)if(g=x.value,E.includes(g))return!0;m='Current user "'+r.name+'" owns the following roles: "'+r.roles.join('", "')+'"'}else m='Current user "'+r.name+"\" doesn't own any role";throw{unauthorized:"Only users with a least on of these roles are allowed to perform requested "+p+' action: "'+[].concat(d[p]).join('", "')+'". '+m+"."}},e.validateDocumentUpdate=function(e,r,n,_,c,i,s){void 0===i&&(i={});var l=function(e,t,r){var n;void 0===t&&(t="forbidden"),void 0===r&&(r={});for(var o=((n={})[t]=e,n.message=e,n.name=t,n),a=0,_=Object.entries(r);a<_.length;a++){var c=_[a],i=c[0],s=c[1];o[i]=s}throw o},u=new Date,p=Date.UTC(u.getUTCFullYear(),u.getUTCMonth(),u.getUTCDate(),u.getUTCHours(),u.getUTCMinutes(),u.getUTCSeconds(),u.getUTCMilliseconds())/1e3,d=!c.dateTimeFormat.startsWith("iso"),f=c.property.name.special,m=f.id,b=f.revision,h=f.type;r&&r[h]&&!e[h]&&(e[h]=r[h]);var y="",O="",x=function(){y=Object.prototype.hasOwnProperty.call(e,m)?e[m]:"",O=Object.prototype.hasOwnProperty.call(e,b)?e[b]:""};if(x(),Object.prototype.hasOwnProperty.call(_,c.property.name.validatedDocumentsCache)&&_[c.property.name.validatedDocumentsCache].has(y+"-"+O))return _[c.property.name.validatedDocumentsCache].delete(y+"-"+O),e;["latest","upsert"].includes(O)&&(r&&Object.prototype.hasOwnProperty.call(r,b)?O=e[b]=r[b]:"latest"===O?l("Revision: No old document available to update."):delete e[b]);var g=c.updateStrategy;Object.prototype.hasOwnProperty.call(e,f.strategy)&&(g=e[f.strategy],delete e[f.strategy]);var E,P={};if("migrate"===g)for(var v=0,D=Object.entries(i);v<D.length;v++){var M=D[v],w=M[0],C=M[1];if(Object.prototype.hasOwnProperty.call(C,f.oldType)&&![null,void 0].includes(C[f.oldType]))for(var k,A,T=a([].concat(C[f.oldType]));!(k=T()).done;)A=k.value,P[A]=w}s?E=s:JSON&&Object.prototype.hasOwnProperty.call(JSON,"stringify")?E=function(e){return JSON.stringify(e,null,4)}:l('Needed "serializer" is not available.');var I=[f.additional,f.allowedRole,f.constraint.execution,f.constraint.expression,f.create.execution,f.create.expression,f.extend,f.maximumAggregatedSize,f.minimumAggregatedSize,f.oldType,f.update.execution,f.update.expression],R=function(e){return e instanceof Error?""+e:E(e)},j=function(e){return"string"==typeof e?e.trim():""},U=function(e){if(d)null!==e&&"number"!=typeof e&&(e=new Date(e),e=Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds())/1e3);else if(null!==e){e=new Date("number"!=typeof e||isNaN(e)?e:1e3*e);try{e=e.toISOString()}catch(e){}}return e},L=function(e,t,r){if(r.fileName){if(r.fileName.value)return r.fileName.value===t;if(r.fileName.regularExpressionPattern)return new RegExp(r.fileName.regularExpressionPattern).test(t)}return e===t},W=function(t,r){if(r||(r=e[f.attachment]),t){for(var n,o=0,a=Object.keys(r);o<a.length;o++)if((n=a[o]).startsWith(t))return n}else{var _=Object.keys(r);if(_.length)return _[0]}return null},B=function(e,r,n){void 0===r&&(r=!1),void 0===n&&(n={});var a=j(e);if(a){var _,c=(r?"return ":"")+a,i=o({},N,{code:c},n),s=Object.keys(i);try{_=t(Function,s.concat([c]))}catch(e){l(R(e),"compilation",{code:c,error:e,scope:i})}var u={code:c,result:void 0,scope:i};try{u.result=_.apply(void 0,s.map((function(e){return i[e]})))}catch(e){l(R(e),"runtime",{code:c,error:e,scope:i})}return u}l("No expression to evaluate provided.","empty")},K=function(e,r,n){void 0===n&&(n=[]);var o=n.length?" in "+n.join(" -> "):"",_=[],s=function(){Object.prototype.hasOwnProperty.call(e,h)||(r&&Object.prototype.hasOwnProperty.call(r,h)&&["fillUp","migrate"].includes(g)?e[h]=r[h]:l('Type: You have to specify a model type via property "'+h+'"'+o+".")),n.length||new RegExp(c.property.name.typeRegularExpressionPattern.public).test(e[h])||l('TypeName: You have to specify a model type which matches "'+c.property.name.typeRegularExpressionPattern.public+'" as public type (given "'+e[h]+'")'+o+"."),Object.prototype.hasOwnProperty.call(i,e[h])||(Object.prototype.hasOwnProperty.call(P,e[h])?e[h]=P[e[h]]:l('Model: Given model "'+e[h]+'" is not specified'+o+"."))};s();var u=e[h],p=i[u],y=null;Object.prototype.hasOwnProperty.call(p,f.additional)&&p[f.additional]&&(y=p[f.additional]);var O=function _(c,i,s,d,f){void 0===f&&(f=["constraintExecution","constraintExpression"]);for(var m,b,h=a(f);!(m=h()).done;)if(b=m.value,Object.prototype.hasOwnProperty.call(s,b)){var y,O=void 0;try{O=B(s[b].evaluation,b.endsWith("Expression"),{checkPropertyContent:_,model:p,modelName:u,name:i,type:b,newDocument:e,newValue:c,oldDocument:r,oldValue:d,parentNames:n,pathDescription:o,propertySpecification:s})}catch(c){if(function(e){return Object.prototype.hasOwnProperty.call(e,"compilation")}(c)&&l('Compilation: Hook "'+b+'" has invalid code "'+c.code+'": "'+c.message+'"'+o+"."),function(e){return Object.prototype.hasOwnProperty.call(e,"runtime")}(c)&&l('Runtime: Hook "'+b+'" has throw an error with code "'+c.code+'": "'+c.message+'"'+o+"."),!Object.prototype.hasOwnProperty.call(c,"empty"))throw c}if(null==(y=O)||!y.result){var x=j(s[b].description);l(b.charAt(0).toUpperCase()+(b.substring(1)+": ")+(x?t(Function,Object.keys(O.scope).concat(["return "+x])).apply(void 0,Object.values(O.scope)):'Property "'+i+'" should satisfy constraint "'+O.code+'" (given "'+R(c)+'")'+o+"."))}}},E=function(e,t,r,_){void 0===_&&(_=null);var c=[],s=[].concat(r.type?r.type:[]);"object"==typeof e&&Object.getPrototypeOf(e)===Object.prototype&&!Object.prototype.hasOwnProperty.call(e,h)&&1===s.length&&Object.prototype.hasOwnProperty.call(i,s[0])&&(e[h]=s[0]);for(var u,p,f=!1,b=a(s);!(u=b()).done;)if(p=u.value,Object.prototype.hasOwnProperty.call(i,p)){if("object"==typeof e&&Object.getPrototypeOf(e)===Object.prototype&&Object.prototype.hasOwnProperty.call(e,h)&&e[h]!==p&&"migrate"===g&&1===s.length&&(e[h]=p,c=n.concat(t,"migrate nested object type")),"object"==typeof e&&Object.getPrototypeOf(e)===Object.prototype&&Object.prototype.hasOwnProperty.call(e,h)&&e[h]===p){var y=K(e,_,n.concat(t));if(y.changedPath.length&&(c=y.changedPath),e=y.newDocument,R(e)===R({}))return{newValue:null,changedPath:c};f=!0;break}1===s.length&&l('NestedType: Under key "'+t+'" isn\'t of type "'+p+'" (given "'+R(e)+'" of type '+typeof e+")"+o+".")}else if("DateTime"===p){var x=e;if(e=U(e),!(d&&("number"!=typeof e||isNaN(e))||!d&&"string"!=typeof e)){f=!0;break}1===s.length&&l('PropertyType: Property "'+t+'" isn\'t of (valid) type "DateTime" (given "'+R(x).replace(/^"/,"").replace(/"$/,"")+'" of type "'+typeof x+'")'+o+".")}else if(["boolean","integer","number","string"].includes(p)){if(!("number"==typeof e&&isNaN(e)||"integer"!==p&&typeof e!==p||"integer"===p&&parseInt(e,10)!==e)){f=!0;break}1===s.length&&l('PropertyType: Property "'+t+'" isn\'t of (valid) type "${type}" (given "'+R(e)+'" of type "'+typeof e+'")'+o+".")}else if("string"==typeof p&&p.startsWith("foreignKey:")){var E=i[p.substring(11)][m].type;if(E===typeof e){f=!0;break}1===s.length&&l('PropertyType: Foreign key property "'+t+'" isn\'t of type "'+E+'" (given "'+R(e)+'" of type "'+typeof e+'")'+o+".")}else{if("any"===p||R(e)===R(p)){f=!0;break}1===s.length&&l('PropertyType: Property "'+t+'" isn\'t value "'+p+'" (given "'+R(e).replace(/^"/,"").replace(/"$/,"")+'" of type "'+typeof e+'")'+o+".")}if(f||l('PropertyType: None of the specified types "'+s.join('", "')+'" for property "'+t+'" matches value "'+R(e).replace(/^"/,"").replace(/"$/,"")+e+'" of type "'+typeof e+'")'+o+"."),"string"==typeof e&&(![null,void 0].includes(r.minimumLength)&&e.length<r.minimumLength&&l('MinimalLength: Property "'+t+'" must have minimal length '+r.minimumLength+" (given "+e+" with length i"+e.length+") "+o+"."),![null,void 0].includes(r.maximumLength)&&e.length>r.maximumLength&&l('MaximalLength: Property "'+t+'" must have maximal length '+r.maximumLength+" (given "+e+" with length "+e.length+")"+o+".")),"number"==typeof e&&(![null,void 0].includes(r.minimum)&&e<r.minimum&&l('Minimum: Property "'+t+'" (type '+r.type+") must satisfy a minimum of "+r.minimum+" (given "+e+" is too low)"+o+"."),![null,void 0].includes(r.maximum)&&e>r.maximum&&l('Maximum: Property "'+t+'" (type '+r.type+") must satisfy a maximum of "+r.maximum+" (given "+e+" is too high)"+o+".")),r.selection){var P=Array.isArray(r.selection)?r.selection.map((function(e){return void 0===(null==e?void 0:e.value)?e:e.value})):Object.keys(r.selection);"DateTime"===r.type&&(P=P.map(U)),P.includes(e)||l('Selection: Property "'+t+'" (type '+r.type+') should be one of "'+P.join('", "')+'". But is "'+e+'"'+o+".")}return[null,void 0].includes(r.regularExpressionPattern)||new RegExp(r.regularExpressionPattern).test(e)?![null,void 0].includes(r.invertedRegularExpressionPattern)&&new RegExp(r.invertedRegularExpressionPattern).test(e)&&l('InvertedPatternMatch: Property "'+t+'" should not match regular expression pattern '+r.invertedRegularExpressionPattern+' (given "'+e+'")'+o+"."):l('PatternMatch: Property "'+t+'" should match regular expression pattern '+r.regularExpressionPattern+' (given "'+e+'")'+o+"."),O(e,t,r,_),R(e)!==R(_)&&(c=n.concat(t,"value updated")),{newValue:e,changedPath:c}},v=function(e,t,r,o,a){var i=t[o];if(!e.writable)if(r){if(Object.prototype.hasOwnProperty.call(r,o)&&R(i)===R(r[o]))return o!==m&&"incremental"===g&&delete t[o],!0;l('Readonly: Property "'+o+'" is not writable (old document "'+R(r)+'")'+a+".")}else l('Readonly: Property "'+o+'" is not writable'+a+".");if(!e.mutable&&r&&Object.prototype.hasOwnProperty.call(r,o)){if(R(i)===R(r[o]))return"incremental"!==g||c.property.name.reserved.concat(f.deleted,m,b).includes(o)||delete t[o],!0;"migrate"!==g&&l('Immutable: Property "'+o+'" is not writable (old document "'+R(r)+'")'+a+".")}if(null===i){if(e.nullable)return delete t[o],r&&Object.prototype.hasOwnProperty.call(r,o)&&(_=n.concat(o,"delete property")),!0;l('NotNull: Property "'+o+'" should not be "null"'+a+".")}return!1},D=function(e,t,r,_){if(!r)for(var c,i,s=a(["onCreateExecution","onCreateExpression"]);!(c=s()).done;)if(i=c.value,Object.prototype.hasOwnProperty.call(e,i)){var d=void 0;try{d=B(e[i],i.endsWith("Expression"),{checkPropertyContent:E,model:p,modelName:u,name:_,type:i,newDocument:t,oldDocument:r,newValue:void 0,oldValue:void 0,parentNames:n,pathDescription:o,propertySpecification:e})}catch(t){if(function(e){return Object.prototype.hasOwnProperty.call(e,"compilation")}(t)&&l('Compilation: Hook "'+i+'" has invalid code "'+t.code+'" for property "'+_+'": '+t.message+o+"."),function(e){return Object.prototype.hasOwnProperty.call(e,"runtime")}(t)&&l('Runtime: Hook "'+i+'" has throw an error with code "'+t.code+'" for property "'+_+'": '+t.message+o+"."),!Object.prototype.hasOwnProperty.call(t,"empty"))throw t}d&&![null,void 0].includes(d.result)&&(t[_]=d.result)}},M=function(e,t,r,_){if(Object.prototype.hasOwnProperty.call(t,_)){e.trim&&"string"==typeof t[_]&&(t[_]=t[_].trim()),e.emptyEqualsToNull&&(""===t[_]||Array.isArray(t[_])&&0===t[_].length||null!==t[_]&&"object"==typeof t[_]&&0===Object.keys(t).length)&&(t[_]=null);for(var c,i,s=a(["onUpdateExecution","onUpdateExpression"]);!(c=s()).done;)if(i=c.value,Object.prototype.hasOwnProperty.call(e,i))try{t[_]=B(e[i],i.endsWith("Expression"),{checkPropertyContent:E,model:p,modelName:u,name:_,type:i,newDocument:t,oldDocument:r,newValue:t[_],oldValue:r&&r[_],parentNames:n,pathDescription:o,propertySpecification:e}).result}catch(t){if(function(e){return Object.prototype.hasOwnProperty.call(e,"compilation")}(t)&&l('Compilation: Hook "'+i+'" has invalid code "'+t.code+'" for property "'+_+'": '+t.message+o+"."),function(e){return Object.prototype.hasOwnProperty.call(e,"runtime")}(t)&&l('Runtime: Hook "'+i+'" has throw an error with code "'+t.code+'" for property "'+_+'": '+t.message+o+"."),!Object.prototype.hasOwnProperty.call(t,"empty"))throw t}}},w=Object.keys(p).filter((function(e){return!I.includes(e)}));if("migrate"===g)for(var C,k,A=a(w);!(C=A()).done;)if(k=C.value,![null,void 0].includes(p[k].oldName))for(var T,W,N=a([].concat(p[k].oldName));!(T=N()).done;)W=T.value,Object.prototype.hasOwnProperty.call(e,W)&&(e[k]=e[W],delete e[W]);if(!r)for(var S,q=0,H=[f.create.execution,f.create.expression];q<H.length;q++)if(S=H[q],Object.prototype.hasOwnProperty.call(p,S)){var F=void 0;try{F=B(p[S],S.endsWith("Expression"),{checkPropertyContent:E,model:p,modelName:u,type:S,newDocument:e,oldDocument:r,parentNames:n,pathDescription:o}).result}catch(s){if(function(e){return Object.prototype.hasOwnProperty.call(e,"compilation")}(s)&&l('Compilation: Hook "'+S+'" has invalid code "'+s.code+'" for document "'+u+'": '+s.message+o+"."),function(e){return Object.prototype.hasOwnProperty.call(e,"runtime")}(s)&&l('Runtime: Hook "'+S+'" has throw an error with code "'+s.code+'" for document "'+u+'": '+s.message+o+"."),!Object.prototype.hasOwnProperty.call(s,"empty"))throw s}[null,void 0].includes(F)||(e=F),s(),u=e[h],0===n.length&&x()}for(var $,z=0,G=[f.update.execution,f.update.expression];z<G.length;z++)if($=G[z],Object.prototype.hasOwnProperty.call(p,$)){var V=void 0;try{V=B(p[$],$.endsWith("Expression"),{checkPropertyContent:E,model:p,modelName:u,type:$,newDocument:e,oldDocument:r,parentNames:n,pathDescription:o}).result}catch(s){if(function(e){return Object.prototype.hasOwnProperty.call(e,"compilation")}(s)&&l('Compilation: Hook "'+$+'" has invalid code "'+s.code+'" for document "'+u+'": '+s.message+o+"."),function(e){return Object.prototype.hasOwnProperty.call(e,"runtime")}(s)&&l('Runtime: Hook "'+$+'" has throw an error with code "'+s.code+'" for document "'+u+'": '+s.message+o+"."),!Object.prototype.hasOwnProperty.call(s,"empty"))throw s}[void 0,null].includes(V)||(e=V),s(),u=e[h],0===n.length&&x()}for(var J,X=function(){var t=J.value;if(f.attachment===t)for(var c=function(){var c=s[i],u=c[0],p=c[1];Object.prototype.hasOwnProperty.call(e,t)&&null!==e[t]||(e[t]={}),r&&!Object.prototype.hasOwnProperty.call(r,t)&&(r[t]={});var d=Object.keys(e[t]).filter((function(r){return null!==e[t][r].data&&L(u,r,p)})),f=e[t],m=[];if(r){var b=r[t];m=Object.keys(b).filter((function(e){return!(Object.prototype.hasOwnProperty.call(f,e)&&Object.prototype.hasOwnProperty.call(f[e],"data")&&null===f[e].data)&&!!b[e]&&(Object.prototype.hasOwnProperty.call(b[e],"data")&&null!==b[e].data||b[e].stub&&!!b[e].digest)&&!!L(u,e,p)}))}for(var h,y,O=p,x=a(d);!(h=x()).done;)y=h.value,D(O,f,r&&r[t]?r[t]:null,y);for(var E,P,v=a(d);!(E=v()).done;)P=E.value,M(O,f,r&&r[t]?r[t]:null,P);if([null,void 0].includes(O.default)){if(O.nullable||0<d.length||0<m.length||l('AttachmentMissing: Missing attachment for type "'+u+'"'+o+"."),"fillUp"===g&&0===d.length&&0<m.length)for(var w,C,k=a(m);!(w=k()).done;)C=w.value,null===f[C]?_=n.concat(t,C,"file removed"):f[C]=r[t][C]}else if(0===d.length)if(0===m.length)for(var A in O.default)Object.prototype.hasOwnProperty.call(O.default,A)&&(f[A]=O.default[A],_=n.concat(t,u,"add default file"));else if("fillUp"===g)for(var T,I,R=a(m);!(T=R()).done;)I=T.value,f[I]=r[t][I]},i=0,s=Object.entries(p[t]);i<s.length;i++)c();else{var u=w.includes(t)?p[t]:y;D(u,e,r,t),M(u,e,r,t),[null,void 0].includes(u.default)?(!(u.nullable||Object.prototype.hasOwnProperty.call(e,t)||r&&Object.prototype.hasOwnProperty.call(r,t)&&g)&&l('MissingProperty: Missing property "'+t+'"'+o+"."),!Object.prototype.hasOwnProperty.call(e,t)&&r&&Object.prototype.hasOwnProperty.call(r,t)&&("fillUp"===g?e[t]=r[t]:!g&&(_=n.concat(t,"property removed")))):(!Object.prototype.hasOwnProperty.call(e,t)||null===e[t])&&(r&&Object.prototype.hasOwnProperty.call(r,t)?"fillUp"===g?e[t]=r[t]:"migrate"===g&&(e[t]=u.default,_=n.concat(t,"migrate default value")):(e[t]=u.default,_=_.concat(t,"add default value")))}},Y=a(w.concat(y?Object.keys(e).filter((function(e){return!w.includes(e)})):[]));!(J=Y()).done;)X();if(r&&"incremental"===g)for(var Z=0,Q=Object.entries(e);Z<Q.length;Z++){var ee=Q[Z],te=ee[0],re=ee[1];!Object.prototype.hasOwnProperty.call(r,te)||c.property.name.reserved.concat(m,b,f.conflict,f.deleted,f.deletedConflict,f.localSequence,f.revisions,f.revisionsInformation,h).includes(te)||r[te]!==re&&R(r[te])!==R(re)||delete e[te]}for(var ne=0,oe=Object.entries(e);ne<oe.length;ne++){var ae=oe[ne],_e=ae[0],ce=ae[1];if(!c.property.name.reserved.concat(b,f.conflict,f.deleted,f.deletedConflict,f.localSequence,f.revisions,f.revisionsInformation,f.strategy).includes(_e)){var ie=void 0;if(Object.prototype.hasOwnProperty.call(p,_e))ie=p[_e];else if(y)ie=y;else{if("migrate"===g){delete e[_e],_=n.concat(_e,"migrate removed property");continue}l('Property: Given property "'+_e+'" isn\'t specified in model "'+u+'"'+o+".")}if(!ie)continue;if(f.attachment===_e){var se=ce;for(var le in se)if(Object.prototype.hasOwnProperty.call(se,le))for(var ue in p[_e])if(L(ue,le,p[_e][ue])){v(p[_e][ue],e,r,le,o);break}continue}if(v(ie,e,r,_e,o))continue;if("string"==typeof ie.type&&ie.type.endsWith("[]")||Array.isArray(ie.type)&&ie.type.length&&Array.isArray(ie.type[0])){var pe,de=ce;Array.isArray(de)?![null,void 0].includes(ie.minimumNumber)&&de.length<ie.minimumNumber?l('MinimumArrayLength: Property "'+_e+'" (array of length '+de.length+") doesn't fullfill minimum array length of "+ie.minimumNumber+o+"."):![null,void 0].includes(ie.maximumNumber)&&ie.maximumNumber<de.length&&l('MaximumArrayLength: Property "'+_e+'" (array of length '+de.length+") doesn't fullfill maximum array length of "+ie.maximumNumber+o+"."):l('PropertyType: Property "'+_e+'" isn\'t of type "array -> '+ie.type+'" (given "'+R(de)+'")'+o+"."),O(de,_e,ie,r&&Object.prototype.hasOwnProperty.call(r,_e)&&r[_e]||void 0,["arrayConstraintExecution","arrayConstraintExpression"]);var fe={};for(var me in ie)Object.prototype.hasOwnProperty.call(ie,me)&&(fe[me]="type"===me?Array.isArray(ie[me])?ie[me][0]:[ie[me].substring(0,ie.type.length-2)]:ie[me]);if(1===(null==(pe=fe.type)?void 0:pe.length)&&Object.prototype.hasOwnProperty.call(i,fe.type[0]))for(var be,he,ye=a(de.slice());!(be=ye()).done;)"object"!=typeof(he=be.value)||Object.getPrototypeOf(he)!==Object.prototype||Object.prototype.hasOwnProperty.call(he,h)||(he[h]=fe.type[0]);for(var Oe,xe,ge=0,Ee=a(de.slice());!(Oe=Ee()).done;)xe=Oe.value,de[ge]=E(xe,ge+1+". value in "+_e,fe).newValue,null===xe&&de.splice(ge,1),ge+=1;r&&Object.prototype.hasOwnProperty.call(r,_e)&&Array.isArray(r[_e])&&r[_e].length===de.length&&R(r[_e])===R(de)||(_=n.concat(_e,"array updated"))}else{var Pe=r&&Object.prototype.hasOwnProperty.call(r,_e)?r[_e]:null,ve=E(ce,_e,ie,Pe);e[_e]=ve.newValue,ve.changedPath.length&&(_=ve.changedPath),null===e[_e]&&(null!==Pe&&(_=n.concat(_e,"property removed")),delete e[_e])}}}for(var De,Me=0,we=Object.keys(f.constraint);Me<we.length;Me++)if(De=we[Me],(De=f.constraint[De])&&Object.prototype.hasOwnProperty.call(p,De))for(var Ce,ke=a([].concat(p[De]));!(Ce=ke()).done;){var Ae,Te=Ce.value,Ie=void 0;try{Ie=B(Te.evaluation,De===f.constraint.expression,{checkPropertyContent:E,model:p,modelName:u,type:De,newDocument:e,oldDocument:r,parentNames:n,pathDescription:o})}catch(s){if(function(e){return Object.prototype.hasOwnProperty.call(e,"compilation")}(s)&&l('Compilation: Hook "'+De+'" has invalid code "'+s.code+'": "'+s.message+'"'+o+"."),function(e){return Object.prototype.hasOwnProperty.call(e,"runtime")}(s)&&l('Runtime: Hook "'+De+'" has thrown an error with code "'+s.code+'": '+s.message+o+"."),!Object.prototype.hasOwnProperty.call(s,"empty"))throw s}if(null==(Ae=Ie)||!Ae.result){var Re=De.replace(/^[^a-zA-Z]+/,"");l(Re.charAt(0).toUpperCase()+(Re.substring(1)+": ")+(Te.description?t(Function,Object.keys(Ie.scope).concat(["return "+Te.description.trim()])).apply(void 0,Object.values(Ie.scope)):'Model "'+u+'" should satisfy constraint "'+Ie.code+'" (given "'+R(e)+'")'+o+"."))}}if(Object.prototype.hasOwnProperty.call(e,f.attachment)){var je=e[f.attachment];("object"!=typeof je||Object.getPrototypeOf(je)!==Object.prototype)&&l("AttachmentType: given attachment has invalid type"+o+".");var Ue=null;if(r&&Object.prototype.hasOwnProperty.call(r,f.attachment)&&null!==(Ue=r[f.attachment])&&"object"==typeof Ue)for(var Le=0,We=Object.entries(Ue);Le<We.length;Le++){var Be=We[Le],Ke=Be[0],Ne=Be[1];if(Object.prototype.hasOwnProperty.call(je,Ke)){var Se=je[Ke];null===Se||null===Se.data||Se.content_type===Ne.content_type&&(Se.data===Ne.data||Se.digest===Ne.digest)?((null===Se||null===Se.data)&&(_=n.concat(f.attachment,Ke,"attachment removed")),"incremental"===g&&delete je[Ke]):_=n.concat(f.attachment,Ke,"attachment updated")}else"fillUp"===g?je[Ke]=Ne:g||(_=n.concat(f.attachment,Ke,"attachment removed"))}for(var qe=0,He=Object.entries(je);qe<He.length;qe++){var Fe=He[qe],$e=Fe[0],ze=Fe[1];[null,void 0].includes(ze)||null===ze.data?delete je[$e]:(!Ue||!Object.prototype.hasOwnProperty.call(Ue,$e)||ze.content_type!==Ue[$e].content_type||ze.data!==Ue[$e].data&&ze.digest!==Ue[$e].digest)&&(_=n.concat(f.attachment,$e,"attachment updated"))}0===Object.keys(je).length&&delete e[f.attachment];for(var Ge={},Ve=0,Je=Object.keys(p[f.attachment]);Ve<Je.length;Ve++)Ge[Je[Ve]]=[];for(var Xe=0,Ye=Object.keys(je);Xe<Ye.length;Xe++){for(var Ze=Ye[Xe],Qe=!1,et=0,tt=Object.entries(p[f.attachment]);et<tt.length;et++){var rt=tt[et],nt=rt[0],ot=rt[1];if(L(nt,Ze,ot)){Ge[nt].push(Ze),Qe=!0;break}}Qe||l('AttachmentTypeMatch: None of the specified attachment types ("'+Object.keys(p[f.attachment]).join('", "')+'") matches given one ("'+Ze+'")'+o+".")}for(var at=0,_t=0,ct=Object.keys(Ge);_t<ct.length;_t++){var it=ct[_t],st=p[f.attachment][it];if(Object.prototype.hasOwnProperty.call(Ge,it)){var lt=Ge[it].length;null!==st.maximumNumber&&lt>st.maximumNumber&&l("AttachmentMaximum: given number of attachments ("+lt+") doesn't satisfy specified maximum of "+st.maximumNumber+' from type "'+it+'"'+o+"."),(!st.nullable||0!==lt)&&lt<st.minimumNumber&&l("AttachmentMinimum: given number of attachments ("+lt+") doesn't satisfy specified minimum of "+st.minimumNumber+' from type "'+it+'"'+o+".");for(var ut,pt=0,dt=a(Ge[it]);!(ut=dt()).done;){var ft,mt,bt=ut.value;null!=(ft=st.fileName)&&ft.regularExpressionPattern&&!new RegExp(st.fileName.regularExpressionPattern).test(bt)?l('AttachmentName: given attachment name "'+bt+'" doesn\'t satisfy specified regular expression pattern "'+st.fileName.regularExpressionPattern+'" from type "'+it+'"'+o+"."):null!=(mt=st.fileName)&&mt.invertedRegularExpressionPattern&&new RegExp(st.fileName.invertedRegularExpressionPattern).test(bt)?l('InvertedAttachmentName: given attachment name "'+bt+'" does satisfy specified regular expression pattern "'+st.fileName.invertedRegularExpressionPattern+'" from type "'+it+'"'+o+"."):!([null,void 0].includes(st.contentTypeRegularExpressionPattern)||je[bt].content_type&&new RegExp(st.contentTypeRegularExpressionPattern).test(je[bt].content_type))&&l('AttachmentContentType: given attachment content type "'+je[bt].content_type+'" doesn\'t satisfy specified regular expression pattern "'+st.contentTypeRegularExpressionPattern+'" from type "'+it+'"'+o+".");var ht=st.invertedContentTypeRegularExpressionPattern;[null,void 0].includes(ht)||je[bt].content_type&&!new RegExp(ht).test(je[bt].content_type)||l('InvertedAttachmentContentType: given attachment content type "'+je[bt].content_type+'" does satisfy specified regular expression pattern "'+ht+'" from type "'+it+'"'+o+".");var yt=0;"length"in je[bt]?yt=je[bt].length:"data"in je[bt]&&(yt=Buffer&&"byteLength"in Buffer?Buffer.byteLength(je[bt].data,"base64"):je[bt].data.length),![null,void 0].includes(st.minimumSize)&&st.minimumSize>yt?l("AttachmentMinimumSize: given attachment size "+yt+" byte doesn't satisfy specified minimum of "+st.minimumSize+" byte "+o+"."):![null,void 0].includes(st.maximumSize)&&st.maximumSize<yt&&l("AttachmentMaximumSize: given attachment size "+yt+" byte doesn't satisfy specified maximum of "+st.maximumSize+" byte "+o+"."),pt+=yt}![null,void 0].includes(st.minimumAggregatedSize)&&st.minimumAggregatedSize>pt?l('AttachmentAggregatedMinimumSize: given aggregated size of attachments from type "'+it+'" '+pt+" byte doesn't satisfy specified minimum of "+st.minimumAggregatedSize+" byte "+o+"."):![null,void 0].includes(st.maximumAggregatedSize)&&st.maximumAggregatedSize<pt&&l('AttachmentAggregatedMaximumSize: given aggregated size of attachments from type "'+it+'" '+pt+" byte doesn't satisfy specified maximum of "+st.maximumAggregatedSize+" byte "+o+"."),at+=pt}}Object.prototype.hasOwnProperty.call(p,f.minimumAggregatedSize)&&![null,void 0].includes(p[f.minimumAggregatedSize])&&p[f.minimumAggregatedSize]>at?l("AggregatedMinimumSize: given aggregated size "+at+" byte doesn't satisfy specified minimum of "+p[f.minimumAggregatedSize]+" byte "+o+"."):![null,void 0].includes(p[f.maximumAggregatedSize])&&p[f.maximumAggregatedSize]<at&&l("AggregatedMaximumSize: given aggregated size "+at+" byte doesn't satisfy specified maximum of "+p[f.maximumAggregatedSize]+" byte "+o+".")}if(r&&Object.prototype.hasOwnProperty.call(r,f.attachment)&&0===Object.keys(r[f.attachment]).length&&delete r[f.attachment],0===_.length&&r&&"migrate"===g)for(var Ot,xt=0,gt=Object.keys(r);xt<gt.length;xt++)Ot=gt[xt],Object.prototype.hasOwnProperty.call(e,Ot)||(_=n.concat(Ot,"migrate removed property"));return{changedPath:_,newDocument:e}},N={attachmentWithPrefixExists:function(t){if(Object.prototype.hasOwnProperty.call(e,f.attachment)){var r=e[f.attachment],n=W(t);if(n)return Object.prototype.hasOwnProperty.call(r[n],"stub")&&r[n].stub||Object.prototype.hasOwnProperty.call(r[n],"data")&&![null,void 0].includes(r[n].data)}return!1},checkDocument:K,getFileNameByPrefix:W,serialize:R,id:y,revision:O,idName:m,revisionName:b,specialNames:f,typeName:h,modelConfiguration:c,models:i,now:u,nowUTCTimestamp:p,securitySettings:_,userContext:n},S=K(e,r);return(!S.newDocument._deleted||r)&&(S.newDocument._deleted&&S.newDocument._deleted!==(null==r?void 0:r._deleted)||S.changedPath.length)||l("NoChange: No new data given. new document: "+R(e)+"; old document: "+R(r)+"."),Object.prototype.hasOwnProperty.call(_,c.property.name.validatedDocumentsCache)?_[c.property.name.validatedDocumentsCache].add(y+"-"+O):_[c.property.name.validatedDocumentsCache]=new Set([y+"-"+O]),S.newDocument},e}(),l=s;e.exports=i}()},,function(e){"use strict";e.exports=__webpack_require__(11)},function(e){"use strict";e.exports=__webpack_require__(12)}],__webpack_module_cache__={};__nested_webpack_require_12__.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return __nested_webpack_require_12__.d(t,{a:t}),t},__nested_webpack_require_12__.d=function(e,t){for(var r in t)__nested_webpack_require_12__.o(t,r)&&!__nested_webpack_require_12__.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},__nested_webpack_require_12__.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},__nested_webpack_require_12__.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var __webpack_exports__={};(function(){"use strict";function _createForOfIteratorHelperLoose(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}__nested_webpack_require_12__.r(__webpack_exports__),__nested_webpack_require_12__.d(__webpack_exports__,{Database:function(){return _Database},default:function(){return __WEBPACK_DEFAULT_EXPORT__}});var _babel_runtime_helpers_extends__WEBPACK_IMPORTED_MODULE_0__=__nested_webpack_require_12__(0),_babel_runtime_helpers_extends__WEBPACK_IMPORTED_MODULE_0___default=__nested_webpack_require_12__.n(_babel_runtime_helpers_extends__WEBPACK_IMPORTED_MODULE_0__),_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_1__=__nested_webpack_require_12__(1),_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_1___default=__nested_webpack_require_12__.n(_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_1__),_babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2__=__nested_webpack_require_12__(2),_babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default=__nested_webpack_require_12__.n(_babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2__),clientnode__WEBPACK_IMPORTED_MODULE_3__=__nested_webpack_require_12__(3),clientnode__WEBPACK_IMPORTED_MODULE_3___default=__nested_webpack_require_12__.n(clientnode__WEBPACK_IMPORTED_MODULE_3__),fs__WEBPACK_IMPORTED_MODULE_4__=__nested_webpack_require_12__(4),fs__WEBPACK_IMPORTED_MODULE_4___default=__nested_webpack_require_12__.n(fs__WEBPACK_IMPORTED_MODULE_4__),path__WEBPACK_IMPORTED_MODULE_5__=__nested_webpack_require_12__(5),path__WEBPACK_IMPORTED_MODULE_5___default=__nested_webpack_require_12__.n(path__WEBPACK_IMPORTED_MODULE_5__),pouchdb__WEBPACK_IMPORTED_MODULE_6__=__nested_webpack_require_12__(11),pouchdb__WEBPACK_IMPORTED_MODULE_6___default=__nested_webpack_require_12__.n(pouchdb__WEBPACK_IMPORTED_MODULE_6__),pouchdb_find__WEBPACK_IMPORTED_MODULE_7__=__nested_webpack_require_12__(12),pouchdb_find__WEBPACK_IMPORTED_MODULE_7___default=__nested_webpack_require_12__.n(pouchdb_find__WEBPACK_IMPORTED_MODULE_7__),_databaseHelper__WEBPACK_IMPORTED_MODULE_9__=__nested_webpack_require_12__(9),_databaseHelper__WEBPACK_IMPORTED_MODULE_9___default=__nested_webpack_require_12__.n(_databaseHelper__WEBPACK_IMPORTED_MODULE_9__),_helper__WEBPACK_IMPORTED_MODULE_8__=__nested_webpack_require_12__(8),_Database=function(){function Database(){}return Database.preLoadService=(t=_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_1___default()(_babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().mark((function e(t){var r,n,o,a,_,c,i,s,l,u,p,d,f,m,b,h,y;return _babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.configuration.couchdb,n=t.services,Object.prototype.hasOwnProperty.call(n,"couchdb")||(n.couchdb={}),o=n.couchdb,Object.prototype.hasOwnProperty.call(o,"connector")||(a=r.model.property.name.special.id,_=r.model.property.name.special.revision,o.connector=pouchdb__WEBPACK_IMPORTED_MODULE_6___default(),c=o.connector.prototype.bulkDocs,o.connector.plugin({bulkDocs:function(){var e=_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_1___default()(_babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().mark((function e(t){var n,o,i,s,l,u,p,d,f,m,b,h,y,O,x,g,E,P,v=arguments;return _babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(o=v.length,i=Array(1<o?o-1:0),s=1;s<o;s++)i[s-1]=v[s];return l=0<i.length&&i[i.length-1]===Database.toggleIDDetermining,u=l?!r.skipIDDetermining:r.skipIDDetermining,l&&i.pop(),p=!Array.isArray(t)&&null!==t&&"object"==typeof t&&a in t?[t]:t,null!=(n=r.connector.fetch)&&n.timeout&&(0===i.length||"object"!=typeof i[0])&&i.unshift({timeout:r.connector.fetch.timeout}),e.next=8,c.call.apply(c,[this,p].concat(i));case 8:d=e.sent,f=[],m=[],b=0,h=_createForOfIteratorHelperLoose(d);case 13:if((y=h()).done){e.next=36;break}if(O=y.value,"object"!=typeof p[b]){e.next=33;break}if(!(_ in p[b])||"conflict"!==O.name||!["latest","upsert"].includes(p[b][_])){e.next=21;break}m.push(p[b]),f.push(b),e.next=33;break;case 21:if(!(a in p[b]&&r.ignoreNoChangeError&&"name"in O&&"forbidden"===O.name&&"message"in O&&O.message.startsWith("NoChange:"))){e.next=33;break}if(d[b]={id:p[b][a],ok:!0},u){e.next=33;break}if(!(_ in p[b])||["latest","upsert"].includes(p[b][_])){e.next=28;break}e.t0=p[b][_],e.next=32;break;case 28:return e.next=30,this.get(d[b].id);case 30:e.t1=_,e.t0=e.sent[e.t1];case 32:d[b].rev=e.t0;case 33:b+=1;case 34:e.next=13;break;case 36:if(!m.length){e.next=43;break}return p=m,l&&i.push(Database.toggleIDDetermining),e.next=41,this.bulkDocs.apply(this,[p].concat(i));case 41:for(x=e.sent,g=_createForOfIteratorHelperLoose(x);!(E=g()).done;)P=E.value,d[f.shift()]=P;case 43:return e.abrupt("return",d);case 44:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}),r.debug&&o.connector.debug.enable("*"),o.connector=o.connector.plugin(pouchdb_find__WEBPACK_IMPORTED_MODULE_7___default())),Object.prototype.hasOwnProperty.call(o,"server")){e.next=36;break}o.server={},i=[],s=_createForOfIteratorHelperLoose([].concat(r.binary.runner));case 8:if((l=s()).done){e.next=34;break}u=l.value,p=_createForOfIteratorHelperLoose([].concat(u.location));case 11:if((d=p()).done){e.next=30;break}f=d.value,m=_createForOfIteratorHelperLoose([].concat(u.name));case 14:if((b=m()).done){e.next=26;break}return h=b.value,y=path__WEBPACK_IMPORTED_MODULE_5___default().resolve(f,h),i.push(y),e.next=20,clientnode__WEBPACK_IMPORTED_MODULE_3___default().isFile(y);case 20:if(!e.sent){e.next=24;break}return u.binaryFilePath=y,o.server.runner=u,e.abrupt("break",26);case 24:e.next=14;break;case 26:if(!Object.prototype.hasOwnProperty.call(o.server,"runner")){e.next=28;break}return e.abrupt("break",30);case 28:e.next=11;break;case 30:if(!Object.prototype.hasOwnProperty.call(o.server,"runner")){e.next=32;break}return e.abrupt("break",34);case 32:e.next=8;break;case 34:if(Object.prototype.hasOwnProperty.call(o.server,"runner")){e.next=36;break}throw new Error('No binary file in one of the following locations found: "'+i.join('", "')+'".');case 36:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)}),Database.loadService=function(){function loadService(){return _loadService.apply(this,arguments)}var _loadService=_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_1___default()(_babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().mark((function _callee3(_ref3){var configuration,services,promise,couchdb,urlPrefix,unauthenticatedUserDatabaseConnection,authenticatedUserDatabaseConnection,_i,_arr,type,_iterator6,_step6,name,userDatabaseConnection,_userDatabaseConnecti,_iterator7,_step7,prefix,subPath,fullPath,url,_value,response,changeNeeded,idName,typeName,modelConfiguration,models,databaseHelperCode,_iterator8,_step8,_type2,code,_i2,_Object$entries,_Object$entries$_i,modelName,model,_i3,_Object$entries2,_Object$entries2$_i,_name,specification,_iterator9,_step9,constraint,property,_iterator10,_step10,_type,_constraint,migrater,_iterator11,_step11,file,extension,basename,document,_forbidden,_iterator12,_step12,retrievedDocument,_document,newDocument,_iterator13,_step13,_name2,result,indexes,_i4,_Object$entries3,_Object$entries3$_i,_modelName,_model,_iterator14,_step14,propertyName,_name3,foundPosition,position,_iterator15,_step15,index,_iterator16,_step16,_index,exists,_i5,_Object$entries4,_Object$entries4$_i,_modelName2,_model2,_iterator17,_step17,_name4;return _babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().wrap((function(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:if(configuration=_ref3.configuration,services=_ref3.services,promise=null,couchdb=services.couchdb,!Object.prototype.hasOwnProperty.call(couchdb.server,"runner")){_context3.next=10;break}return _context3.next=6,_helper__WEBPACK_IMPORTED_MODULE_8__.default.startServer(services,configuration);case 6:couchdb.server.restart=_helper__WEBPACK_IMPORTED_MODULE_8__.default.restartServer,couchdb.server.start=_helper__WEBPACK_IMPORTED_MODULE_8__.default.startServer,couchdb.server.stop=_helper__WEBPACK_IMPORTED_MODULE_8__.default.stopServer,promise=new Promise((function(e,t){couchdb.server.resolve=e,couchdb.server.reject=t}));case 10:if(!Object.prototype.hasOwnProperty.call(couchdb,"connection")){_context3.next=12;break}return _context3.abrupt("return",{couchdb:promise});case 12:if(urlPrefix=clientnode__WEBPACK_IMPORTED_MODULE_3___default().stringFormat(configuration.couchdb.url,configuration.couchdb.user.name+":"+configuration.couchdb.user.password+"@"),!configuration.couchdb.ensureAdminPresence){_context3.next=44;break}return unauthenticatedUserDatabaseConnection=new couchdb.connector(clientnode__WEBPACK_IMPORTED_MODULE_3___default().stringFormat(configuration.couchdb.url,"")+"/_users",_helper__WEBPACK_IMPORTED_MODULE_8__.default.getConnectorOptions(configuration)),_context3.prev=15,_context3.next=18,unauthenticatedUserDatabaseConnection.allDocs();case 18:return _context3.next=21,clientnode__WEBPACK_IMPORTED_MODULE_3__.globalContext.fetch(clientnode__WEBPACK_IMPORTED_MODULE_3___default().stringFormat(configuration.couchdb.url,"")+"/"+couchdb.server.runner.adminUserConfigurationPath+"/"+configuration.couchdb.user.name,{body:'"'+configuration.couchdb.user.password+'"',method:"PUT"});case 21:_context3.next=41;break;case 23:if(_context3.prev=23,_context3.t0=_context3.catch(15),"unauthorized"!==_context3.t0.name){_context3.next=40;break}return authenticatedUserDatabaseConnection=new couchdb.connector(urlPrefix+"/_users",_helper__WEBPACK_IMPORTED_MODULE_8__.default.getConnectorOptions(configuration)),_context3.prev=27,_context3.next=30,authenticatedUserDatabaseConnection.allDocs();case 30:_context3.next=35;break;case 32:_context3.prev=32,_context3.t1=_context3.catch(27);case 35:return _context3.prev=35,authenticatedUserDatabaseConnection.close(),_context3.finish(35);case 38:_context3.next=41;break;case 40:case 41:return _context3.prev=41,unauthenticatedUserDatabaseConnection.close(),_context3.finish(41);case 44:if(!configuration.couchdb.ensureUserPresence){_context3.next=79;break}_i=0,_arr=[configuration.couchdb.security.admins,configuration.couchdb.security.members];case 46:if(!(_i<_arr.length)){_context3.next=79;break}type=_arr[_i],_iterator6=_createForOfIteratorHelperLoose(type.names);case 49:if((_step6=_iterator6()).done){_context3.next=76;break}return name=_step6.value,userDatabaseConnection=new couchdb.connector(urlPrefix+"/_users",_helper__WEBPACK_IMPORTED_MODULE_8__.default.getConnectorOptions(configuration)),_context3.prev=52,_context3.next=55,userDatabaseConnection.get("org.couchdb.user:"+name);case 55:_context3.next=71;break;case 57:if(_context3.prev=57,_context3.t2=_context3.catch(52),"not_found"!==_context3.t2.error){_context3.next=70;break}return _context3.prev=60,_context3.next=63,userDatabaseConnection.put((_userDatabaseConnecti={},_userDatabaseConnecti[configuration.couchdb.model.property.name.special.id]="org.couchdb.user:"+name,_userDatabaseConnecti.name=name,_userDatabaseConnecti.password=name,_userDatabaseConnecti.roles=[].concat(type.roles.includes(name+"s")?name+"s":[]),_userDatabaseConnecti.type="user",_userDatabaseConnecti));case 63:_context3.next=68;break;case 65:throw _context3.prev=65,_context3.t3=_context3.catch(60),new Error("Couldn't create missing user \""+name+'": '+clientnode__WEBPACK_IMPORTED_MODULE_3___default().represent(_context3.t3));case 68:_context3.next=71;break;case 70:throw new Error("Couldn't check for presence of user \""+name+'": '+clientnode__WEBPACK_IMPORTED_MODULE_3___default().represent(_context3.t2));case 71:return _context3.prev=71,userDatabaseConnection.close(),_context3.finish(71);case 74:_context3.next=49;break;case 76:_i++,_context3.next=46;break;case 79:if(!configuration.couchdb.model.updateConfiguration){_context3.next=134;break}_iterator7=_createForOfIteratorHelperLoose(configuration.couchdb.backend.prefixes);case 81:if((_step7=_iterator7()).done){_context3.next=134;break}prefix=_step7.value,_context3.t4=_babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().keys(configuration.couchdb.backend.configuration);case 84:if((_context3.t5=_context3.t4()).done){_context3.next=132;break}if(subPath=_context3.t5.value,!Object.prototype.hasOwnProperty.call(configuration.couchdb.backend.configuration,subPath)){_context3.next=130;break}return fullPath="/"+prefix+(prefix.trim()?"/":"")+subPath,url=""+urlPrefix+fullPath,_value=configuration.couchdb.backend.configuration[subPath],response=void 0,_context3.prev=91,_context3.next=94,clientnode__WEBPACK_IMPORTED_MODULE_3__.globalContext.fetch(url);case 94:response=_context3.sent,_context3.next=100;break;case 97:_context3.prev=97,_context3.t6=_context3.catch(91);case 100:if(!response){_context3.next=130;break}if(!response.ok){_context3.next=129;break}if(changeNeeded=!0,"function"!=typeof response.text){_context3.next=115;break}return _context3.prev=104,_context3.t7=_value,_context3.next=108,response["string"==typeof _value?"text":"json"]();case 108:_context3.t8=_context3.sent,changeNeeded=_context3.t7===_context3.t8,_context3.next=115;break;case 112:_context3.prev=112,_context3.t9=_context3.catch(104);case 115:if(!changeNeeded){_context3.next=126;break}return _context3.prev=116,_context3.next=119,clientnode__WEBPACK_IMPORTED_MODULE_3__.globalContext.fetch(url,{body:'"'+configuration.couchdb.backend.configuration[subPath]+'"',method:"PUT"});case 119:_context3.next=124;break;case 121:_context3.prev=121,_context3.t10=_context3.catch(116);case 124:_context3.next=127;break;case 126:case 127:_context3.next=130;break;case 129:case 130:_context3.next=84;break;case 132:_context3.next=81;break;case 134:return _context3.next=136,_helper__WEBPACK_IMPORTED_MODULE_8__.default.initializeConnection(services,configuration);case 136:if(idName=configuration.couchdb.model.property.name.special.id,typeName=configuration.couchdb.model.property.name.special.type,!configuration.couchdb.ensureSecuritySettingsPresence){_context3.next=147;break}return _context3.prev=139,_context3.next=142,clientnode__WEBPACK_IMPORTED_MODULE_3__.globalContext.fetch(urlPrefix+"/"+configuration.couchdb.databaseName+"/_security",{body:JSON.stringify(configuration.couchdb.security),method:"PUT"});case 142:_context3.next=147;break;case 144:_context3.prev=144,_context3.t11=_context3.catch(139);case 147:if(modelConfiguration=clientnode__WEBPACK_IMPORTED_MODULE_3___default().copy(configuration.couchdb.model),delete modelConfiguration.property.defaultSpecification,delete modelConfiguration.entities,models=_helper__WEBPACK_IMPORTED_MODULE_8__.default.extendModels(configuration.couchdb.model),!configuration.couchdb.model.updateValidation){_context3.next=215;break}return _context3.next=154,fs__WEBPACK_IMPORTED_MODULE_4__.promises.readFile(eval("require.resolve('./databaseHelper')"),{encoding:configuration.core.encoding,flag:"r"});case 154:databaseHelperCode=_context3.sent,_iterator8=_createForOfIteratorHelperLoose([{description:"Model specification",methodName:"validateDocumentUpdate",name:"validation",serializedParameter:JSON.stringify(modelConfiguration)+", "+JSON.stringify(models)},{description:"Authorisation",methodName:"authenticate",name:"authentication",serializedParameter:JSON.stringify(_helper__WEBPACK_IMPORTED_MODULE_8__.default.determineAllowedModelRolesMapping(configuration.couchdb.model))+", '"+idName+"', '"+typeName+"', '"+configuration.couchdb.model.property.name.special.designDocumentNamePrefix+"'"}]);case 156:if((_step8=_iterator8()).done){_context3.next=171;break}_type2=_step8.value,code="function(...parameters) {\n    return require('helper').default."+_type2.methodName+"(...parameters.concat(["+_type2.serializedParameter+"]))\n}",_context3.prev=159,new Function("return "+code),_context3.next=166;break;case 163:throw _context3.prev=163,_context3.t12=_context3.catch(159),new Error("Generated "+_type2.name+' code "'+code+"\" doesn't compile: "+clientnode__WEBPACK_IMPORTED_MODULE_3___default().represent(_context3.t12));case 166:return configuration.core.debug,_context3.next=169,_helper__WEBPACK_IMPORTED_MODULE_8__.default.ensureValidationDocumentPresence(couchdb.connection,_type2.name,{helper:databaseHelperCode,validate_doc_update:code},_type2.description,!0,idName,modelConfiguration.property.name.special.designDocumentNamePrefix);case 169:_context3.next=156;break;case 171:_i2=0,_Object$entries=Object.entries(models);case 172:if(!(_i2<_Object$entries.length)){_context3.next=215;break}_Object$entries$_i=_Object$entries[_i2],modelName=_Object$entries$_i[0],model=_Object$entries$_i[1],_i3=0,_Object$entries2=Object.entries(model);case 175:if(!(_i3<_Object$entries2.length)){_context3.next=212;break}if(_Object$entries2$_i=_Object$entries2[_i3],_name=_Object$entries2$_i[0],specification=_Object$entries2$_i[1],![modelConfiguration.property.name.special.constraint.execution,modelConfiguration.property.name.special.constraint.expression].includes(_name)){_context3.next=193;break}_iterator9=_createForOfIteratorHelperLoose([].concat(specification));case 179:if((_step9=_iterator9()).done){_context3.next=191;break}if(constraint=_step9.value,!constraint.description){_context3.next=189;break}_context3.prev=182,new Function("return "+constraint.description),_context3.next=189;break;case 186:throw _context3.prev=186,_context3.t13=_context3.catch(182),new Error('Specified constraint description "'+constraint.description+'" for model "'+modelName+'" doesn\'t compile: "'+clientnode__WEBPACK_IMPORTED_MODULE_3___default().represent(_context3.t13)+'".');case 189:_context3.next=179;break;case 191:_context3.next=209;break;case 193:property=specification,_iterator10=_createForOfIteratorHelperLoose(["conflictingConstraintExpression","conflictingConstraintExecution","constraintExpression","constraintExecution"]);case 195:if((_step10=_iterator10()).done){_context3.next=209;break}if(_type=_step10.value,null===property||"object"!=typeof property){_context3.next=207;break}if(_constraint=property[_type],null==_constraint||!_constraint.description){_context3.next=207;break}_context3.prev=200,new Function(_constraint.description),_context3.next=207;break;case 204:throw _context3.prev=204,_context3.t14=_context3.catch(200),new Error('Specified constraint description "'+_constraint.description+'" for model "'+modelName+'" in property "'+_name+'" as "'+_type+'" doesn\'t compile: "'+clientnode__WEBPACK_IMPORTED_MODULE_3___default().represent(_context3.t14)+'".');case 207:_context3.next=195;break;case 209:_i3++,_context3.next=175;break;case 212:_i2++,_context3.next=172;break;case 215:if(!configuration.couchdb.model.autoMigrationPath){_context3.next=314;break}return migrater={},_context3.next=219,clientnode__WEBPACK_IMPORTED_MODULE_3___default().isDirectory(path__WEBPACK_IMPORTED_MODULE_5___default().resolve(configuration.couchdb.model.autoMigrationPath));case 219:if(!_context3.sent){_context3.next=266;break}return _context3.t15=_createForOfIteratorHelperLoose,_context3.next=223,clientnode__WEBPACK_IMPORTED_MODULE_3___default().walkDirectoryRecursively(path__WEBPACK_IMPORTED_MODULE_5___default().resolve(configuration.couchdb.model.autoMigrationPath),configuration.couchdb.debug?clientnode__WEBPACK_IMPORTED_MODULE_3___default().noop:function(e){return"debug"!==e.name});case 223:_context3.t16=_context3.sent,_iterator11=(0,_context3.t15)(_context3.t16);case 225:if((_step11=_iterator11()).done){_context3.next=266;break}if(file=_step11.value,extension=path__WEBPACK_IMPORTED_MODULE_5___default().extname(file.name),basename=path__WEBPACK_IMPORTED_MODULE_5___default().basename(file.name,extension),".json"!==extension){_context3.next=256;break}return document=void 0,_context3.prev=231,_context3.t17=JSON,_context3.next=235,fs__WEBPACK_IMPORTED_MODULE_4__.promises.readFile(file.path,{encoding:configuration.core.encoding,flag:"r"});case 235:_context3.t18=_context3.sent,document=_context3.t17.parse.call(_context3.t17,_context3.t18),_context3.next=242;break;case 239:throw _context3.prev=239,_context3.t19=_context3.catch(231),new Error('Parsing document "'+file.path+'" to include by automigration of has failed: '+clientnode__WEBPACK_IMPORTED_MODULE_3___default().represent(_context3.t19));case 242:return document[idName]=basename,document[configuration.couchdb.model.property.name.special.revision]="upsert",_context3.prev=244,_context3.next=247,couchdb.connection.put(document);case 247:_context3.next=253;break;case 249:throw _context3.prev=249,_context3.t20=_context3.catch(244),null!=(_forbidden=_context3.t20.forbidden)&&_forbidden.startsWith("NoChange:"),new Error('Migrating document "'+document[idName]+'" of type "'+document[typeName]+'" has failed: '+clientnode__WEBPACK_IMPORTED_MODULE_3___default().represent(_context3.t20));case 253:_context3.next=264;break;case 256:if(![".js"].includes(path__WEBPACK_IMPORTED_MODULE_5___default().extname(file.name))){_context3.next=260;break}migrater[file.path]=eval("require('"+file.path+"')").default,_context3.next=264;break;case 260:if(![".mjs"].includes(path__WEBPACK_IMPORTED_MODULE_5___default().extname(file.name))){_context3.next=264;break}return _context3.next=263,eval("import('"+file.path+"')");case 263:migrater[file.path]=_context3.sent.default;case 264:_context3.next=225;break;case 266:return _context3.t21=_createForOfIteratorHelperLoose,_context3.next=269,couchdb.connection.allDocs({include_docs:!0});case 269:_context3.t22=_context3.sent.rows,_iterator12=(0,_context3.t21)(_context3.t22);case 271:if((_step12=_iterator12()).done){_context3.next=314;break}if(retrievedDocument=_step12.value,"string"==typeof retrievedDocument.id&&retrievedDocument.id.startsWith(configuration.couchdb.model.property.name.special.designDocumentNamePrefix)){_context3.next=312;break}_document=retrievedDocument.doc,newDocument=clientnode__WEBPACK_IMPORTED_MODULE_3___default().copy(_document),newDocument[configuration.couchdb.model.property.name.special.strategy]="migrate",_iterator13=_createForOfIteratorHelperLoose(Object.keys(migrater).sort());case 278:if((_step13=_iterator13()).done){_context3.next=291;break}_name2=_step13.value,result=null,_context3.prev=281,result=migrater[_name2](newDocument,{configuration,databaseHelper:_databaseHelper__WEBPACK_IMPORTED_MODULE_9___default(),idName,migrater,models,modelConfiguration,selfFilePath:_name2,services,tools:clientnode__WEBPACK_IMPORTED_MODULE_3___default(),typeName}),_context3.next=288;break;case 285:throw _context3.prev=285,_context3.t23=_context3.catch(281),new Error('Running migrater "'+_name2+'" in document '+_helper__WEBPACK_IMPORTED_MODULE_8__.default.mayStripRepresentation(_document,configuration.couchdb.maximumRepresentationTryLength,configuration.couchdb.maximumRepresentationLength)+'" failed: '+clientnode__WEBPACK_IMPORTED_MODULE_3___default().represent(_context3.t23));case 288:result&&(newDocument=result);case 289:_context3.next=278;break;case 291:_context3.prev=291,_databaseHelper__WEBPACK_IMPORTED_MODULE_9___default().validateDocumentUpdate(clientnode__WEBPACK_IMPORTED_MODULE_3___default().copy(newDocument),clientnode__WEBPACK_IMPORTED_MODULE_3___default().copy(_document),{db:configuration.couchdb.databaseName,name:configuration.couchdb.user.name,roles:["_admin"]},clientnode__WEBPACK_IMPORTED_MODULE_3___default().copy(configuration.couchdb.security),modelConfiguration,models),_context3.next=303;break;case 295:if(_context3.prev=295,_context3.t24=_context3.catch(291),!Object.prototype.hasOwnProperty.call(_context3.t24,"forbidden")){_context3.next=302;break}return _context3.t24.forbidden.startsWith("NoChange:"),_context3.abrupt("continue",312);case 302:throw _context3.t24;case 303:return _context3.prev=303,_context3.next=306,couchdb.connection.put(newDocument);case 306:_context3.next=311;break;case 308:throw _context3.prev=308,_context3.t25=_context3.catch(303),new Error('Replaceing auto migrated document "'+newDocument[idName]+'" has failed: '+clientnode__WEBPACK_IMPORTED_MODULE_3___default().represent(_context3.t25));case 311:case 312:_context3.next=271;break;case 314:if(!configuration.couchdb.createGenericFlatIndex||!configuration.couchdb.model.autoMigrationPath){_context3.next=369;break}return _context3.next=317,couchdb.connection.getIndexes();case 317:indexes=_context3.sent.indexes,_i4=0,_Object$entries3=Object.entries(models);case 319:if(!(_i4<_Object$entries3.length)){_context3.next=350;break}if(_Object$entries3$_i=_Object$entries3[_i4],_modelName=_Object$entries3$_i[0],_model=_Object$entries3$_i[1],!new RegExp(configuration.couchdb.model.property.name.typeRegularExpressionPattern.public).test(_modelName)){_context3.next=347;break}return _context3.next=324,couchdb.connection.createIndex({index:{ddoc:_modelName+"-GenericIndex",fields:[typeName],name:_modelName+"-GenericIndex"}});case 324:_iterator14=_createForOfIteratorHelperLoose(_helper__WEBPACK_IMPORTED_MODULE_8__.default.determineGenericIndexablePropertyNames(configuration.couchdb.model,_model));case 325:if((_step14=_iterator14()).done){_context3.next=347;break}propertyName=_step14.value,_name3=_modelName+"-"+propertyName+"-GenericIndex",foundPosition=-1,position=0,_iterator15=_createForOfIteratorHelperLoose(indexes);case 331:if((_step15=_iterator15()).done){_context3.next=339;break}if(index=_step15.value,index.name!==_name3){_context3.next=336;break}return foundPosition=position,_context3.abrupt("break",339);case 336:position+=1;case 337:_context3.next=331;break;case 339:if(-1!==foundPosition){_context3.next=344;break}return _context3.next=342,couchdb.connection.createIndex({index:{ddoc:_name3,fields:[typeName,propertyName],name:_name3}});case 342:_context3.next=345;break;case 344:indexes.slice(position,1);case 345:_context3.next=325;break;case 347:_i4++,_context3.next=319;break;case 350:_iterator16=_createForOfIteratorHelperLoose(indexes);case 351:if((_step16=_iterator16()).done){_context3.next=369;break}if(_index=_step16.value,!_index.name.endsWith("-GenericIndex")){_context3.next=367;break}exists=!1,_i5=0,_Object$entries4=Object.entries(models);case 356:if(!(_i5<_Object$entries4.length)){_context3.next=364;break}if(_Object$entries4$_i=_Object$entries4[_i5],_modelName2=_Object$entries4$_i[0],_model2=_Object$entries4$_i[1],!_index.name.startsWith(_modelName2+"-")){_context3.next=361;break}for(_iterator17=_createForOfIteratorHelperLoose(_helper__WEBPACK_IMPORTED_MODULE_8__.default.determineGenericIndexablePropertyNames(configuration.couchdb.model,_model2));!(_step17=_iterator17()).done;)_name4=_step17.value,[_modelName2+"-"+_name4+"-GenericIndex",_modelName2+"-GenericIndex"].includes(_index.name)&&(exists=!0);return _context3.abrupt("break",364);case 361:_i5++,_context3.next=356;break;case 364:if(exists){_context3.next=367;break}return _context3.next=367,couchdb.connection.deleteIndex(_index);case 367:_context3.next=351;break;case 369:if(!configuration.couchdb.model.triggerInitialCompaction){_context3.next=378;break}return _context3.prev=370,_context3.next=373,couchdb.connection.compact();case 373:_context3.next=378;break;case 375:_context3.prev=375,_context3.t26=_context3.catch(370);case 378:return _context3.abrupt("return",{couchdb:promise});case 379:case"end":return _context3.stop()}}),_callee3,null,[[15,23,41,44],[27,32,35,38],[52,57,71,74],[60,65],[91,97],[104,112],[116,121],[139,144],[159,163],[182,186],[200,204],[231,239],[244,249],[281,285],[291,295],[303,308],[370,375]])})));return loadService}(),Database.postLoadService=function(e){var t=e.configuration.couchdb,r=e.pluginAPI,n=e.services.couchdb,o=0;setInterval((function(){0<o&&(o=0)}),3e4);var a=clientnode__WEBPACK_IMPORTED_MODULE_3___default().debounce(_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_1___default()(_babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().mark((function _(){return _babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().wrap((function(_){for(;;)switch(_.prev=_.next){case 0:return n.changesStream&&n.changesStream.cancel(),n.changesStream=n.connection.changes(t.changesStream),n.changesStream.on("error",_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_1___default()(_babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().mark((function t(){return _babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(3<(o+=1))){t.next=9;break}return o=0,n.changesStream.cancel(),t.next=7,n.server.restart(e);case 7:t.next=10;break;case 9:case 10:a();case 11:case"end":return t.stop()}}),t)})))),_.next=5,r.callStack(_babel_runtime_helpers_extends__WEBPACK_IMPORTED_MODULE_0___default()({},e,{data:n.changesStream,hook:"couchdbInitializeChangesStream"}));case 5:case"end":return _.stop()}}),_)}))));return t.attachAutoRestarter&&a(),Promise.resolve()},Database.shouldExit=function(){var e=_babel_runtime_helpers_asyncToGenerator__WEBPACK_IMPORTED_MODULE_1___default()(_babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().mark((function e(t){var r,n,o;return _babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_2___default().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.configuration,n=t.services,e.next=3,_helper__WEBPACK_IMPORTED_MODULE_8__.default.stopServer(n,r);case 3:return delete n.couchdb,o="log.txt",e.next=7,clientnode__WEBPACK_IMPORTED_MODULE_3___default().isFile(o);case 7:if(!e.sent){e.next=10;break}return e.next=10,fs__WEBPACK_IMPORTED_MODULE_4__.promises.unlink(o);case 10:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),Database;var t}();_Database.toggleIDDetermining=Symbol("toggleIDDetermining");var __WEBPACK_DEFAULT_EXPORT__=_Database})(),module.exports=__webpack_exports__})()},,e=>{"use strict";e.exports=require("pouchdb")},e=>{"use strict";e.exports=require("pouchdb-find")}],__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var r=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](r,r.exports,__webpack_require__),r.exports}var __webpack_exports__=__webpack_require__(9);module.exports=__webpack_exports__})();